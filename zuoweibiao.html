<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­çº§åº§ä½è¡¨ç®¡ç†ç³»ç»Ÿ</title>
    <!-- å¼•å…¥ SheetJS åº“ç”¨äºå¤„ç† Excel æ–‡ä»¶ -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Microsoft YaHei", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            padding: 10px;
            overflow: hidden;
            /* Prevent body scroll */
        }

        .container {
            max-width: 100%;
            height: calc(100vh - 20px);
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            flex-shrink: 0;
        }

        h1 {
            color: #333;
            font-size: 24px;
            margin: 0;
        }

        .top-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .main-content {
            display: flex;
            flex: 1;
            gap: 20px;
            overflow: hidden;
        }

        /* å·¦ä¾§åº§ä½åŒº */
        .seating-area {
            flex: 2;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding-right: 10px;
        }

        .classroom {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
            flex: 1;
            justify-content: center;
            /* Center vertically */
        }

        .row {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .group {
            display: flex;
            gap: 6px;
        }

        .seat {
            width: 100px;
            height: 55px;
            border: 2px dashed #ccc;
            border-radius: 6px;
            background: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 0;
            position: relative;
            transition: all 0.3s;
            overflow: hidden;
        }

        /* æ‹–æ‹½è¿›è¡Œä¸­æ—¶ï¼Œåº§ä½å†…çš„å­¦ç”Ÿå¡ç‰‡ä¸é˜»æ­¢æ‹–æ”¾ */
        body.dragging-active .seat .student-card:not(.dragging) {
            pointer-events: none;
        }

        .seat:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .seat.drag-over {
            border-color: #764ba2;
            background: #e8d5ff;
            border-style: solid;
        }

        .seat.occupied {
            border-style: solid;
            border-color: #28a745;
            background: #d4edda;
        }

        .student-card {
            background: white;
            color: #333;
            padding: 0;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-size: 15px;
            font-weight: 500;
            cursor: move;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
            flex-shrink: 0;
            user-select: none;
            -webkit-user-drag: element;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* åº§ä½ä¸­çš„å­¦ç”Ÿåç‰Œ - å……æ»¡æ•´ä¸ªåº§ä½ */
        .seat .student-card {
            width: 100%;
            height: 100%;
        }

        /* å­¦ç”Ÿæ± ä¸­çš„å­¦ç”Ÿåç‰Œ - å›ºå®šå°å°ºå¯¸ */
        .student-pool .student-card {
            width: 90px;
            height: 36px;
            padding: 6px 10px;
        }

        .student-card:hover {
            transform: scale(1.05);
        }

        .student-card.dragging {
            opacity: 0.5;
        }

        /* è®²å° */
        .podium {
            margin-top: 10px;
            padding: 10px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            text-align: center;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            flex-shrink: 0;
        }

        /* å³ä¾§åå•åŒº */
        .student-list-area {
            flex: 1;
            border-left: 2px solid #e0e0e0;
            padding-left: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            resize: vertical;
            margin-bottom: 10px;
        }

        .student-pool {
            flex: 1;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 10px;
            overflow-y: auto;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-content: flex-start;
        }

        .stats {
            margin-top: 10px;
            padding: 10px;
            background: #e7f3ff;
            border-radius: 8px;
            font-size: 13px;
            color: #333;
            flex-shrink: 0;
        }

        .stats div {
            margin-bottom: 5px;
        }

        .stats span {
            font-weight: bold;
            color: #667eea;
        }

        /* å¯¼å…¥å¯¹è¯æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-content h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .modal-content textarea {
            min-height: 200px;
        }

        .modal-footer {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ ç­çº§åº§ä½è¡¨ç®¡ç†ç³»ç»Ÿ</h1>
            <div class="top-controls">
                <button class="btn btn-primary" onclick="openImportModal()">ğŸ“¥ å¯¼å…¥åå•</button>
                <button class="btn btn-primary" onclick="triggerExcelUpload()">ğŸ“Š å¯¼å…¥Excel</button>
                <input type="file" id="excelFileInput" accept=".xlsx, .xls" style="display: none;"
                    onchange="handleExcelUpload(event)">
                <button class="btn btn-primary" onclick="loadTestData()" style="background: #28a745;">ğŸ§ª æµ‹è¯•æ•°æ®</button>
                <button class="btn btn-secondary" onclick="exportSeating()">ğŸ’¾ å¯¼å‡ºHTML</button>
                <button class="btn btn-secondary" onclick="exportToExcel()">ğŸ“Š å¯¼å‡ºExcel</button>
                <button class="btn btn-danger" onclick="clearAll()">ğŸ—‘ï¸ æ¸…ç©º</button>
                <div style="width: 1px; height: 20px; background: #ddd; margin: 0 5px;"></div>
                <button class="btn btn-primary" onclick="rotateGroups('left')">â¬…ï¸ å°ç»„å·¦ç§»</button>
                <button class="btn btn-primary" onclick="rotateGroups('right')">å°ç»„å³ç§» â¡ï¸</button>
                <button class="btn btn-primary" onclick="rotateRows('backward')">â¬‡ï¸ å‘åè½®æ¢</button>
                <button class="btn btn-primary" onclick="rotateRows('forward')">â¬†ï¸ å‘å‰è½®æ¢</button>
            </div>
        </div>

        <div class="main-content">
            <!-- å·¦ä¾§åº§ä½åŒº -->
            <div class="seating-area">
                <div class="classroom" id="classroom">
                    <!-- åº§ä½å°†ç”±JavaScriptç”Ÿæˆ -->
                </div>
                <div class="podium">ğŸ¯ è®² å° ğŸ¯</div>
            </div>

            <!-- å³ä¾§å­¦ç”Ÿåå•åŒº -->
            <div class="student-list-area">
                <h3 style="margin-bottom: 10px; color: #333; font-size: 16px;">æœªå®‰æ’å­¦ç”Ÿ</h3>
                <div class="student-pool" id="studentPool">
                    <div style="color: #999; width: 100%; text-align: center; padding: 40px 0;">
                        è¯·å…ˆå¯¼å…¥å­¦ç”Ÿåå•
                    </div>
                </div>

                <div class="stats" id="stats">
                    <div>æ€»åº§ä½æ•°: <span id="totalSeats">56</span></div>
                    <div>å·²å®‰æ’: <span id="assignedSeats">0</span></div>
                    <div>æœªå®‰æ’å­¦ç”Ÿ: <span id="unassignedStudents">0</span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- å¯¼å…¥åå•å¯¹è¯æ¡† -->
    <div class="modal" id="importModal">
        <div class="modal-content">
            <h2>ğŸ“ å¯¼å…¥å­¦ç”Ÿåå•</h2>
            <p style="color: #666; margin-bottom: 15px;">è¯·è¾“å…¥å­¦ç”Ÿå§“åï¼Œæ¯è¡Œä¸€ä¸ªï¼š</p>
            <textarea id="studentInput" placeholder="ä¾‹å¦‚ï¼š&#10;å¼ ä¸‰&#10;æå››&#10;ç‹äº”&#10;..."></textarea>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeImportModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="importStudents()">ç¡®è®¤å¯¼å…¥</button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let students = [];
        let seatingData = {};
        const TOTAL_SEATS = 56;
        const COLS_PER_ROW = 8;
        const ROWS = 7;

        // LocalStorage é”®å
        const STORAGE_KEY_STUDENTS = 'seating_chart_students';
        const STORAGE_KEY_SEATING = 'seating_chart_data';

        // ä¿å­˜æ•°æ®åˆ° localStorage
        function saveToLocalStorage() {
            try {
                localStorage.setItem(STORAGE_KEY_STUDENTS, JSON.stringify(students));
                localStorage.setItem(STORAGE_KEY_SEATING, JSON.stringify(seatingData));
                console.log('æ•°æ®å·²è‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°');
            } catch (e) {
                console.error('ä¿å­˜æ•°æ®å¤±è´¥:', e);
            }
        }

        // ä» localStorage åŠ è½½æ•°æ®
        function loadFromLocalStorage() {
            try {
                const savedStudents = localStorage.getItem(STORAGE_KEY_STUDENTS);
                const savedSeating = localStorage.getItem(STORAGE_KEY_SEATING);

                if (savedStudents) {
                    students = JSON.parse(savedStudents);
                    console.log('å·²åŠ è½½å­¦ç”Ÿåå•:', students.length, 'åå­¦ç”Ÿ');
                }

                if (savedSeating) {
                    seatingData = JSON.parse(savedSeating);
                    console.log('å·²åŠ è½½åº§ä½å®‰æ’');
                }

                if (savedStudents || savedSeating) {
                    // æ¢å¤ç•Œé¢æ˜¾ç¤º
                    updateAllSeats();
                    renderStudentPool();
                    updateStats();
                    return true;
                }
            } catch (e) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', e);
            }
            return false;
        }

        // æ¸…é™¤æœ¬åœ°å­˜å‚¨
        function clearLocalStorage() {
            localStorage.removeItem(STORAGE_KEY_STUDENTS);
            localStorage.removeItem(STORAGE_KEY_SEATING);
            console.log('æœ¬åœ°æ•°æ®å·²æ¸…é™¤');
        }


        // åˆå§‹åŒ–åº§ä½è¡¨
        function initSeating() {
            const classroom = document.getElementById('classroom');
            classroom.innerHTML = '';

            let seatNumber = 1;

            for (let row = 0; row < ROWS; row++) {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'row';

                // ç¬¬ä¸€ç»„ (1-2å·åº§ä½)
                const group1 = document.createElement('div');
                group1.className = 'group';
                for (let i = 0; i < 2; i++) {
                    group1.appendChild(createSeat(seatNumber++));
                }
                rowDiv.appendChild(group1);

                // ç¬¬äºŒç»„ (3-4å·åº§ä½)
                const group2 = document.createElement('div');
                group2.className = 'group';
                for (let i = 0; i < 2; i++) {
                    group2.appendChild(createSeat(seatNumber++));
                }
                rowDiv.appendChild(group2);

                // ç¬¬ä¸‰ç»„ (5-6å·åº§ä½)
                const group3 = document.createElement('div');
                group3.className = 'group';
                for (let i = 0; i < 2; i++) {
                    group3.appendChild(createSeat(seatNumber++));
                }
                rowDiv.appendChild(group3);

                // ç¬¬å››ç»„ (7-8å·åº§ä½)
                const group4 = document.createElement('div');
                group4.className = 'group';
                for (let i = 0; i < 2; i++) {
                    group4.appendChild(createSeat(seatNumber++));
                }
                rowDiv.appendChild(group4);

                classroom.appendChild(rowDiv);
            }

            updateStats();
        }

        // åˆ›å»ºå•ä¸ªåº§ä½
        function createSeat(number) {
            const seat = document.createElement('div');
            seat.className = 'seat';
            seat.dataset.seatNumber = number;

            // æ‹–æ”¾äº‹ä»¶ - ä½¿ç”¨æ•è·æ¨¡å¼ç¡®ä¿äº‹ä»¶è¢«æ­£ç¡®å¤„ç†
            seat.addEventListener('dragover', handleDragOver, false);
            seat.addEventListener('drop', handleDrop, false);
            seat.addEventListener('dragleave', handleDragLeave, false);
            seat.addEventListener('dragenter', handleDragEnter, false);

            return seat;
        }

        // æ‹–æ‹½è¿›å…¥åº§ä½
        function handleDragEnter(e) {
            e.preventDefault();
            console.log('æ‹–æ‹½è¿›å…¥åº§ä½:', e.currentTarget.dataset.seatNumber);
        }

        // æ‰“å¼€å¯¼å…¥å¯¹è¯æ¡†
        function openImportModal() {
            document.getElementById('importModal').classList.add('active');
        }

        // å…³é—­å¯¼å…¥å¯¹è¯æ¡†
        function closeImportModal() {
            document.getElementById('importModal').classList.remove('active');
        }

        // å¯¼å…¥å­¦ç”Ÿ
        function importStudents() {
            const input = document.getElementById('studentInput').value;
            const names = input.split('\n').filter(name => name.trim() !== '');

            if (names.length === 0) {
                alert('è¯·è¾“å…¥å­¦ç”Ÿå§“åï¼');
                return;
            }

            students = [...new Set(names.map(name => name.trim()))]; // å»é‡
            renderStudentPool();
            closeImportModal();
            document.getElementById('studentInput').value = '';
            updateStats();
            saveToLocalStorage(); // è‡ªåŠ¨ä¿å­˜
        }

        // è§¦å‘Excelæ–‡ä»¶ä¸Šä¼ 
        function triggerExcelUpload() {
            document.getElementById('excelFileInput').click();
        }

        // å¤„ç†Excelæ–‡ä»¶ä¸Šä¼ 
        function handleExcelUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    // è¯»å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                    // æå–å­¦ç”Ÿå§“åï¼ˆè¿‡æ»¤ç©ºè¡Œå’Œç©ºå€¼ï¼‰
                    const names = [];
                    jsonData.forEach(row => {
                        if (row && row.length > 0) {
                            // å°è¯•ä»ç¬¬ä¸€åˆ—æˆ–ä»»ä½•åˆ—è·å–å§“å
                            const name = String(row[0]).trim();
                            if (name && name !== '' && name !== 'undefined') {
                                names.push(name);
                            }
                        }
                    });

                    if (names.length === 0) {
                        alert('Excelæ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„å­¦ç”Ÿå§“åï¼');
                        return;
                    }

                    // å»é‡å¹¶æ›´æ–°å­¦ç”Ÿåˆ—è¡¨
                    students = [...new Set(names)];
                    renderStudentPool();
                    updateStats();
                    saveToLocalStorage(); // è‡ªåŠ¨ä¿å­˜
                    alert(`æˆåŠŸå¯¼å…¥ ${students.length} åå­¦ç”Ÿï¼`);

                } catch (error) {
                    console.error('Excelè§£æé”™è¯¯:', error);
                    alert('Excelæ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·ç¡®ä¿æ–‡ä»¶æ ¼å¼æ­£ç¡®ï¼\né”™è¯¯ä¿¡æ¯: ' + error.message);
                }
            };

            reader.onerror = function () {
                alert('æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
            };

            reader.readAsArrayBuffer(file);

            // æ¸…ç©ºinputï¼Œå…è®¸é‡å¤ä¸Šä¼ åŒä¸€æ–‡ä»¶
            event.target.value = '';
        }

        // æ¸²æŸ“å­¦ç”Ÿåå•æ± 
        function renderStudentPool() {
            const pool = document.getElementById('studentPool');
            pool.innerHTML = '';

            const unassignedStudents = students.filter(student => {
                return !Object.values(seatingData).flat().includes(student);
            });

            if (unassignedStudents.length === 0) {
                pool.innerHTML = '<div style="color: #999; width: 100%; text-align: center; padding: 40px 0;">æ‰€æœ‰å­¦ç”Ÿå·²å®‰æ’</div>';
                return;
            }

            unassignedStudents.forEach(student => {
                const card = createStudentCard(student);
                pool.appendChild(card);
            });
        }

        // åˆ›å»ºå­¦ç”Ÿåç‰Œ
        function createStudentCard(name) {
            const card = document.createElement('div');
            card.className = 'student-card';
            card.textContent = name;
            card.draggable = true;
            card.dataset.studentName = name;

            card.addEventListener('dragstart', handleDragStart);
            card.addEventListener('dragend', handleDragEnd);

            return card;
        }

        // æ‹–æ‹½å¼€å§‹
        function handleDragStart(e) {
            console.log('æ‹–æ‹½å¼€å§‹:', e.target.dataset.studentName);
            e.target.classList.add('dragging');
            document.body.classList.add('dragging-active');
            e.dataTransfer.effectAllowed = 'move';
            const studentName = e.target.dataset.studentName;
            e.dataTransfer.setData('text/plain', studentName);
            e.dataTransfer.setData('text', studentName);
        }

        // æ‹–æ‹½ç»“æŸ
        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            document.body.classList.remove('dragging-active');
            // æ¸…é™¤æ‰€æœ‰åº§ä½çš„ drag-over çŠ¶æ€
            document.querySelectorAll('.seat.drag-over').forEach(seat => {
                seat.classList.remove('drag-over');
            });
        }

        // æ‹–æ‹½ç»è¿‡åº§ä½
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            e.dataTransfer.dropEffect = 'move';

            // ç¡®ä¿æ˜¯åº§ä½å…ƒç´ 
            const seat = e.currentTarget;
            if (seat && seat.classList.contains('seat')) {
                seat.classList.add('drag-over');
            }

            return false;
        }

        // æ‹–æ‹½ç¦»å¼€åº§ä½
        function handleDragLeave(e) {
            const seat = e.currentTarget;
            if (seat && seat.classList.contains('seat')) {
                seat.classList.remove('drag-over');
            }
        }

        // æ”¾ç½®åˆ°åº§ä½
        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();

            // æŸ¥æ‰¾æœ€è¿‘çš„åº§ä½å…ƒç´ 
            let seat = e.currentTarget;
            if (!seat.classList.contains('seat')) {
                seat = seat.closest('.seat');
            }

            if (seat && seat.classList.contains('seat')) {
                seat.classList.remove('drag-over');
            }

            const studentName = e.dataTransfer.getData('text/plain') || e.dataTransfer.getData('text');
            const targetSeatNumber = seat ? seat.dataset.seatNumber : null;

            console.log('=== Dropäº‹ä»¶è§¦å‘ ===');
            console.log('æ”¾ç½®å­¦ç”Ÿ:', studentName, 'åˆ°åº§ä½:', targetSeatNumber);

            if (!studentName) {
                console.error('æœªè·å–åˆ°å­¦ç”Ÿå§“å');
                return;
            }

            if (!targetSeatNumber) {
                console.error('æœªæ‰¾åˆ°åº§ä½å·');
                return;
            }

            // æŸ¥æ‰¾è¯¥å­¦ç”Ÿå½“å‰æ‰€åœ¨çš„åº§ä½
            let sourceSeatNumber = null;
            Object.keys(seatingData).forEach(seatNum => {
                if (seatingData[seatNum] && seatingData[seatNum].includes(studentName)) {
                    sourceSeatNumber = seatNum;
                }
            });

            // å¦‚æœæ‹–åˆ°åŒä¸€ä¸ªåº§ä½ï¼Œä¸åšä»»ä½•æ“ä½œ
            if (sourceSeatNumber === targetSeatNumber) {
                console.log('æ‹–åˆ°åŒä¸€ä¸ªåº§ä½ï¼Œä¸åšå¤„ç†');
                return;
            }

            // åˆå§‹åŒ–ç›®æ ‡åº§ä½æ•°ç»„ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            if (!seatingData[targetSeatNumber]) {
                seatingData[targetSeatNumber] = [];
            }

            // æ£€æŸ¥ç›®æ ‡åº§ä½æ˜¯å¦æœ‰å­¦ç”Ÿ
            const targetStudent = seatingData[targetSeatNumber][0]; // ç›®æ ‡åº§ä½çš„å­¦ç”Ÿ

            if (targetStudent) {
                // ç›®æ ‡åº§ä½æœ‰å­¦ç”Ÿ - æ‰§è¡Œäº¤æ¢
                console.log('ğŸ”„ äº¤æ¢åº§ä½:', studentName, 'â†”ï¸', targetStudent);

                // å¦‚æœæºå­¦ç”Ÿæ¥è‡ªåº§ä½ï¼ˆä¸æ˜¯å­¦ç”Ÿæ± ï¼‰
                if (sourceSeatNumber) {
                    // äº¤æ¢ä¸¤ä¸ªå­¦ç”Ÿçš„ä½ç½®
                    seatingData[targetSeatNumber] = [studentName];
                    seatingData[sourceSeatNumber] = [targetStudent];

                    // æ›´æ–°ä¸¤ä¸ªåº§ä½çš„æ˜¾ç¤º
                    const sourceSeat = document.querySelector(`.seat[data-seat-number="${sourceSeatNumber}"]`);
                    if (sourceSeat) {
                        updateSeatDisplay(sourceSeat, sourceSeatNumber);
                    }
                } else {
                    // æºå­¦ç”Ÿæ¥è‡ªå­¦ç”Ÿæ± ï¼Œç›®æ ‡åº§ä½æœ‰äººï¼Œä¸å…è®¸æ“ä½œ
                    alert('è¯¥åº§ä½å·²æœ‰å­¦ç”Ÿï¼è¯·å…ˆç§»é™¤æˆ–é€‰æ‹©ç©ºåº§ä½ã€‚');
                    return;
                }
            } else {
                // ç›®æ ‡åº§ä½ä¸ºç©º - ç›´æ¥ç§»åŠ¨
                console.log('â¡ï¸ ç§»åŠ¨å­¦ç”Ÿåˆ°ç©ºåº§ä½');

                // ä»åŸåº§ä½ç§»é™¤
                if (sourceSeatNumber) {
                    seatingData[sourceSeatNumber] = seatingData[sourceSeatNumber].filter(name => name !== studentName);
                    if (seatingData[sourceSeatNumber].length === 0) {
                        delete seatingData[sourceSeatNumber];
                    }

                    // æ›´æ–°åŸåº§ä½æ˜¾ç¤º
                    const sourceSeat = document.querySelector(`.seat[data-seat-number="${sourceSeatNumber}"]`);
                    if (sourceSeat) {
                        updateSeatDisplay(sourceSeat, sourceSeatNumber);
                    }
                }

                // æ·»åŠ åˆ°ç›®æ ‡åº§ä½
                seatingData[targetSeatNumber] = [studentName];
            }

            console.log('å½“å‰åº§ä½æ•°æ®:', seatingData);
            console.log('âœ… æ“ä½œæˆåŠŸï¼');

            // æ›´æ–°ç›®æ ‡åº§ä½æ˜¾ç¤º
            updateSeatDisplay(seat, targetSeatNumber);
            renderStudentPool();
            updateStats();
            saveToLocalStorage(); // è‡ªåŠ¨ä¿å­˜
        }

        // ä»åº§ä½ä¸­ç§»é™¤å­¦ç”Ÿ
        function removeStudentFromSeats(studentName) {
            Object.keys(seatingData).forEach(seatNum => {
                seatingData[seatNum] = seatingData[seatNum].filter(name => name !== studentName);
                if (seatingData[seatNum].length === 0) {
                    delete seatingData[seatNum];
                }
            });
        }

        // æ›´æ–°åº§ä½æ˜¾ç¤º
        function updateSeatDisplay(seatElement, seatNumber) {
            // æ¸…é™¤åº§ä½å†…å®¹
            seatElement.innerHTML = '';

            const studentsInSeat = seatingData[seatNumber] || [];

            if (studentsInSeat.length > 0) {
                seatElement.classList.add('occupied');
                studentsInSeat.forEach(student => {
                    const card = createStudentCard(student);
                    seatElement.appendChild(card);
                });
            } else {
                seatElement.classList.remove('occupied');
            }
        }

        // æ›´æ–°æ‰€æœ‰åº§ä½æ˜¾ç¤º
        function updateAllSeats() {
            document.querySelectorAll('.seat').forEach(seat => {
                const seatNumber = seat.dataset.seatNumber;
                updateSeatDisplay(seat, seatNumber);
            });
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const assignedCount = Object.keys(seatingData).reduce((sum, key) => {
                return sum + seatingData[key].length;
            }, 0);

            const unassignedCount = students.length - assignedCount;

            document.getElementById('totalSeats').textContent = TOTAL_SEATS;
            document.getElementById('assignedSeats').textContent = assignedCount;
            document.getElementById('unassignedStudents').textContent = unassignedCount;
        }

        // å¯¼å‡ºåº§ä½è¡¨ï¼ˆA4æ‰“å°æ ¼å¼ï¼‰
        function exportSeating() {
            // ç”ŸæˆHTMLå†…å®¹
            let html = `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­çº§åº§ä½è¡¨</title>
    <style>
        @page {
            size: A4 portrait;
            margin: 10mm;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "Microsoft YaHei", Arial, sans-serif;
            padding: 10px;
            background: white;
            max-width: 190mm;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 15px;
            page-break-inside: avoid;
        }
        
        h1 {
            font-size: 22px;
            color: #333;
            margin-bottom: 5px;
        }
        
        .info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .classroom {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 15px;
            page-break-inside: avoid;
        }
        
        .row {
            display: flex;
            justify-content: center;
            gap: 12px;
        }
        
        .group {
            display: flex;
            gap: 6px;
        }
        
        .seat {
            width: 85px;
            height: 48px;
            border: 2px solid #333;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 500;
            background: white;
            color: #333;
        }
        
        .seat.empty {
            border-style: dashed;
            border-color: #999;
            color: #999;
            font-size: 11px;
        }
        
        .podium {
            margin-top: 15px;
            padding: 12px;
            border: 3px solid #333;
            border-radius: 6px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            background: #f5f5f5;
            page-break-inside: avoid;
        }
        
        .stats {
            margin-top: 15px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #f9f9f9;
            page-break-inside: avoid;
        }
        
        .stats-item {
            display: inline-block;
            margin-right: 25px;
            font-size: 13px;
        }
        
        @media print {
            body {
                padding: 0;
                max-width: 100%;
            }
            .no-print {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“ ç­çº§åº§ä½è¡¨</h1>
        <div class="info">å¯¼å‡ºæ—¶é—´ï¼š${new Date().toLocaleString('zh-CN')}</div>
    </div>
    
    <div class="classroom">`;

            // ç”Ÿæˆåº§ä½è¡¨
            let seatNumber = 1;
            for (let row = 0; row < ROWS; row++) {
                html += `\n        <div class="row">`;

                // 4ä¸ªç»„ï¼Œæ¯ç»„2ä¸ªåº§ä½
                for (let group = 0; group < 4; group++) {
                    html += `\n            <div class="group">`;

                    for (let col = 0; col < 2; col++) {
                        const students = seatingData[seatNumber] || [];
                        const studentName = students[0] || '';
                        const isEmpty = !studentName;

                        html += `\n                <div class="seat${isEmpty ? ' empty' : ''}">`;
                        html += isEmpty ? 'ç©º' : studentName;
                        html += `</div>`;

                        seatNumber++;
                    }

                    html += `\n            </div>`;
                }

                html += `\n        </div>`;
            }

            html += `\n    </div>
    
    <div class="podium">ğŸ¯ è®² å° ğŸ¯</div>
    
    <div class="stats">
        <div class="stats-item">æ€»åº§ä½æ•°ï¼š${TOTAL_SEATS}</div>
        <div class="stats-item">å·²å®‰æ’ï¼š${Object.keys(seatingData).reduce((sum, key) => sum + seatingData[key].length, 0)}</div>
        <div class="stats-item">æœªå®‰æ’ï¼š${students.length - Object.keys(seatingData).reduce((sum, key) => sum + seatingData[key].length, 0)}</div>
    </div>
    
    <div class="no-print" style="margin-top: 20px; text-align: center;">
        <button onclick="window.print()" style="padding: 10px 30px; font-size: 16px; cursor: pointer; background: #667eea; color: white; border: none; border-radius: 5px;">ğŸ–¨ï¸ æ‰“å°åº§ä½è¡¨</button>
    </div>
</body>
</html>`;

            // åˆ›å»ºä¸‹è½½
            const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ç­çº§åº§ä½è¡¨.html';
            a.click();
            URL.revokeObjectURL(url);

            alert('åº§ä½è¡¨å·²å¯¼å‡ºï¼\n\næ‰“å¼€ä¸‹è½½çš„HTMLæ–‡ä»¶åï¼š\n1. ç‚¹å‡»"æ‰“å°åº§ä½è¡¨"æŒ‰é’®\n2. æˆ–ç›´æ¥æŒ‰ Ctrl+P (Windows) / Cmd+P (Mac)\n3. é€‰æ‹©æ‰“å°æœºæˆ–ä¿å­˜ä¸ºPDF');
        }

        // å¯¼å‡ºä¸ºExcel
        function exportToExcel() {
            // åˆ›å»ºå·¥ä½œç°¿
            const wb = XLSX.utils.book_new();

            // åˆ›å»ºåº§ä½è¡¨æ•°æ®æ•°ç»„
            const wsData = [];

            // æ·»åŠ æ ‡é¢˜
            wsData.push(['ç­çº§åº§ä½è¡¨']);
            wsData.push([`å¯¼å‡ºæ—¶é—´ï¼š${new Date().toLocaleString('zh-CN')}`]);
            wsData.push([]); // ç©ºè¡Œ

            // ç”Ÿæˆåº§ä½è¡¨æ•°æ®
            let seatNumber = 1;
            for (let row = 0; row < ROWS; row++) {
                const rowData = [];

                // 4ä¸ªç»„ï¼Œæ¯ç»„2ä¸ªåº§ä½
                for (let group = 0; group < 4; group++) {
                    for (let col = 0; col < 2; col++) {
                        const students = seatingData[seatNumber] || [];
                        const studentName = students[0] || '';
                        rowData.push(studentName || 'ç©º');
                        seatNumber++;
                    }

                    // åœ¨ç»„ä¹‹é—´æ·»åŠ ç©ºåˆ—
                    if (group < 3) {
                        rowData.push('');
                    }
                }

                wsData.push(rowData);
            }

            // æ·»åŠ è®²å°
            wsData.push([]);
            wsData.push(['', '', '', 'ğŸ¯ è®² å° ğŸ¯']);

            // æ·»åŠ ç»Ÿè®¡ä¿¡æ¯
            wsData.push([]);
            const assignedCount = Object.keys(seatingData).reduce((sum, key) => sum + seatingData[key].length, 0);
            wsData.push([`æ€»åº§ä½æ•°ï¼š${TOTAL_SEATS}`, `å·²å®‰æ’ï¼š${assignedCount}`, `æœªå®‰æ’ï¼š${students.length - assignedCount}`]);

            // åˆ›å»ºå·¥ä½œè¡¨
            const ws = XLSX.utils.aoa_to_sheet(wsData);

            // è®¾ç½®åˆ—å®½
            const colWidths = [];
            for (let i = 0; i < 11; i++) {
                colWidths.push({ wch: i % 3 === 2 ? 3 : 12 }); // ç»„é—´éš”åˆ—çª„ä¸€äº›
            }
            ws['!cols'] = colWidths;

            // åˆå¹¶æ ‡é¢˜å•å…ƒæ ¼
            ws['!merges'] = [
                { s: { r: 0, c: 0 }, e: { r: 0, c: 10 } }, // æ ‡é¢˜è¡Œ
                { s: { r: 1, c: 0 }, e: { r: 1, c: 10 } }  // æ—¶é—´è¡Œ
            ];

            // æ·»åŠ å·¥ä½œè¡¨åˆ°å·¥ä½œç°¿
            XLSX.utils.book_append_sheet(wb, ws, 'åº§ä½è¡¨');

            // å¯¼å‡ºæ–‡ä»¶
            XLSX.writeFile(wb, 'ç­çº§åº§ä½è¡¨.xlsx');

            alert('Excelæ–‡ä»¶å·²å¯¼å‡ºæˆåŠŸï¼');
        }

        // æ¸…ç©ºæ‰€æœ‰åº§ä½
        function clearAll() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰åº§ä½å®‰æ’å—ï¼Ÿ')) {
                return;
            }

            seatingData = {};
            updateAllSeats();
            renderStudentPool();
            updateStats();
            clearLocalStorage(); // æ¸…é™¤æœ¬åœ°å­˜å‚¨
        }

        // åŠ è½½æµ‹è¯•æ•°æ®
        function loadTestData() {
            students = [
                'å¼ ä¸‰', 'æå››', 'ç‹äº”', 'èµµå…­', 'é’±ä¸ƒ', 'å­™å…«',
                'å‘¨ä¹', 'å´å', 'éƒ‘åä¸€', 'ç‹åäºŒ', 'å†¯åä¸‰', 'é™ˆåå››',
                'è¤šåäº”', 'å«åå…­', 'è’‹åä¸ƒ', 'æ²ˆåå…«', 'éŸ©åä¹', 'æ¨äºŒå'
            ];
            renderStudentPool();
            updateStats();
            saveToLocalStorage(); // è‡ªåŠ¨ä¿å­˜
            alert('å·²åŠ è½½18åæµ‹è¯•å­¦ç”Ÿï¼è¯·å°è¯•æ‹–æ‹½åç‰Œåˆ°åº§ä½ä¸Šã€‚');
        }

        // å°ç»„è½®æ¢
        function rotateGroups(direction) {
            const newSeatingData = {};
            let hasChanges = false;

            // éå†æ‰€æœ‰å¯èƒ½çš„åº§ä½
            for (let seatNum = 1; seatNum <= TOTAL_SEATS; seatNum++) {
                const seatKey = String(seatNum);
                const students = seatingData[seatKey];
                if (!students || students.length === 0) continue;

                hasChanges = true;

                // è®¡ç®—å½“å‰ä½ç½® (0-indexed)
                const s = seatNum - 1;
                const r = Math.floor(s / 8);
                const c = s % 8;
                const g = Math.floor(c / 2);
                const p = c % 2;

                // è®¡ç®—æ–°ä½ç½®
                let newG;
                if (direction === 'right') {
                    newG = (g + 1) % 4;
                } else {
                    newG = (g - 1 + 4) % 4;
                }

                const newC = newG * 2 + p;
                const newS = r * 8 + newC + 1;

                newSeatingData[String(newS)] = students;
            }

            if (hasChanges) {
                seatingData = newSeatingData;
                updateAllSeats();
                updateStats();
                saveToLocalStorage(); // è‡ªåŠ¨ä¿å­˜
            }
        }

        // æ’è½®æ¢
        function rotateRows(direction) {
            const newSeatingData = {};
            let hasChanges = false;

            for (let seatNum = 1; seatNum <= TOTAL_SEATS; seatNum++) {
                const seatKey = String(seatNum);
                const students = seatingData[seatKey];
                if (!students || students.length === 0) continue;

                hasChanges = true;

                const s = seatNum - 1;
                const r = Math.floor(s / 8);
                const c = s % 8;

                let newR;
                // backward: 1->2 (å‘åç§»)
                // forward: 2->1 (å‘å‰ç§»)
                if (direction === 'backward') {
                    newR = (r + 1) % ROWS;
                } else {
                    newR = (r - 1 + ROWS) % ROWS;
                }

                const newS = newR * 8 + c + 1;
                newSeatingData[String(newS)] = students;
            }

            if (hasChanges) {
                seatingData = newSeatingData;
                updateAllSeats();
                updateStats();
                saveToLocalStorage(); // è‡ªåŠ¨ä¿å­˜
            }
        }

        // åˆå§‹åŒ–å­¦ç”Ÿæ± æ‹–æ”¾
        function initStudentPool() {
            const pool = document.getElementById('studentPool');

            pool.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                pool.style.background = '#e0f7fa';
            });

            pool.addEventListener('dragleave', (e) => {
                pool.style.background = '#f8f9fa';
            });

            pool.addEventListener('drop', (e) => {
                e.preventDefault();
                pool.style.background = '#f8f9fa';

                const studentName = e.dataTransfer.getData('text/plain') || e.dataTransfer.getData('text');
                console.log('å­¦ç”Ÿè¿”å›å­¦ç”Ÿæ± :', studentName);

                if (studentName) {
                    // ä»åº§ä½ç§»é™¤
                    removeStudentFromSeats(studentName);
                    updateAllSeats();
                    renderStudentPool();
                    updateStats();
                    saveToLocalStorage(); // è‡ªåŠ¨ä¿å­˜
                }
            });
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function () {
            initSeating();
            initStudentPool();

            // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®
            const hasData = loadFromLocalStorage();
            if (hasData) {
                console.log('âœ… å·²æ¢å¤ä¸Šæ¬¡ä¿å­˜çš„åº§ä½å®‰æ’');
            }
        };
    </script>
</body>

</html>