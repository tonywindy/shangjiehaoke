<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°å¯¹å››å­æ£‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: white;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            color: #333;
            overflow: hidden;
        }
        
        .game-container {
            background: #DEB887;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            width: 100%;
            max-width: 1200px;
            height: 90vh;
            max-height: 675px; /* 16:9æ¯”ä¾‹ */
            overflow: hidden;
            border: 10px solid #8B4513;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: linear-gradient(90deg, #8B4513, #A0522D);
            color: #FFD700;
            padding: 10px 20px;
            text-align: center;
            border-bottom: 5px solid #654321;
            flex-shrink: 0;
        }
        
        .header h1 {
            font-size: 28px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .game-area {
            display: flex;
            flex: 1;
            padding: 10px;
            position: relative;
            overflow: hidden;
            justify-content: center;
            align-items: center;
        }
        
        .input-section {
            flex: 1;
            padding: 8px;
            display: flex;
            flex-direction: column;
            min-width: 180px;
            max-width: 220px;
        }
        
        .input-display {
            background: #F5F5DC;
            border: 3px solid #8B4513;
            border-radius: 10px;
            padding: 8px;
            margin-bottom: 8px;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            height: 45px;
            display: flex;
            justify-content: center;
            align-items: center;
            letter-spacing: 2px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.2);
        }
        
        .keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            margin-bottom: 8px;
        }
        
        .key {
            padding: 12px 0; /* ä»10pxå¢åŠ åˆ°12pxï¼Œæé«˜è§¦æ§èˆ’é€‚åº¦ */
            background: #8B4513;
            color: #FFD700;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 0 #654321;
            /* æ·»åŠ è§¦æ§å‹å¥½çš„æ ·å¼ */
            touch-action: manipulation; /* ä¼˜åŒ–è§¦æ§å“åº” */
            min-height: 44px; /* ç¡®ä¿æœ€å°è§¦æ§åŒºåŸŸ44px */
        }
        
        .key:hover {
            background: #A0522D;
            transform: translateY(2px);
            box-shadow: 0 2px 0 #654321;
        }
        
        /* æ·»åŠ è§¦æ§åé¦ˆæ ·å¼ */
        .intersection:active {
            background: rgba(139, 69, 19, 0.2);
            border-radius: 50%;
        }
        
        .key:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #654321;
            background: #A0522D; /* è§¦æ§æ—¶çš„é¢œè‰²åé¦ˆ */
        }
        
        .action-buttons button:active {
            transform: translateY(2px);
            background: #A0522D; /* è§¦æ§æ—¶çš„é¢œè‰²åé¦ˆ */
        }
        
        /* ä¸ºè§¦æ§è®¾å¤‡ä¼˜åŒ–çš„åª’ä½“æŸ¥è¯¢ */
        @media (hover: none) and (pointer: coarse) {
            .intersection {
                width: 24px; /* åœ¨è§¦æ§è®¾å¤‡ä¸Šè¿›ä¸€æ­¥å¢å¤§ */
                height: 24px;
            }
            
            .key {
                min-height: 48px; /* åœ¨è§¦æ§è®¾å¤‡ä¸Šå¢åŠ åˆ°48px */
                padding: 14px 0;
            }
            
            .action-buttons button {
                min-height: 48px; /* åœ¨è§¦æ§è®¾å¤‡ä¸Šå¢åŠ åˆ°48px */
                padding: 12px 8px;
            }
        }
        
        .key.comma {
            background: #CD853F;
        }
        
        .key.comma:hover {
            background: #D2691E;
        }
        
        .action-buttons {
            display: flex;
            gap: 6px;
            margin-top: 5px;
        }
        
        .action-buttons button {
            flex: 1;
            padding: 10px 8px; /* ä»8pxå¢åŠ åˆ°10pxï¼Œæé«˜è§¦æ§èˆ’é€‚åº¦ */
            font-size: 14px;
            font-weight: bold;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
            /* æ·»åŠ è§¦æ§å‹å¥½çš„æ ·å¼ */
            touch-action: manipulation; /* ä¼˜åŒ–è§¦æ§å“åº” */
            min-height: 44px; /* ç¡®ä¿æœ€å°è§¦æ§åŒºåŸŸ44px */
        }
        
        .action-buttons button:hover {
            transform: translateY(2px);
            box-shadow: 0 2px 0 rgba(0,0,0,0.2);
        }
        
        .action-buttons button:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 rgba(0,0,0,0.2);
        }
        
        .action-buttons .confirm {
            background: #27ae60;
            color: white;
        }
        
        .action-buttons .confirm:hover {
            background: #219653;
        }
        
        .action-buttons .clear {
            background: #e74c3c;
            color: white;
        }
        
        .action-buttons .clear:hover {
            background: #c0392b;
        }
        
        .action-buttons .restart {
            background: #f39c12;
            color: white;
        }
        
        .action-buttons .restart:hover {
            background: #d68910;
        }
        
        .board-section {
            flex: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 5px;
            min-width: 380px;
            max-width: 420px;
            margin: 20px 20px 0 20px; /* æ·»åŠ ä¸Šè¾¹è· */
        }
        
        .board-container {
            background: #DEB887;
            border: 5px solid #8B4513;
            border-radius: 5px;
            padding: 20px 20px 35px 35px;
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
            position: relative;
            margin-top: 10px; /* æ·»åŠ é¢å¤–çš„ä¸Šè¾¹è· */
        }
        
        #gameBoard {
            position: relative;
            background: #DEB887;
            width: 280px; /* ä»300pxç¼©å°åˆ°280px */
            height: 280px; /* ä»300pxç¼©å°åˆ°280px */
        }
        
        .grid-line {
            position: absolute;
            background: #8B4513;
        }
        
        .horizontal-line {
            width: 100%;
            height: 2px;
            left: 0;
        }
        
        .vertical-line {
            height: 100%;
            width: 2px;
            top: 0;
        }
        
        .intersection {
            position: absolute;
            width: 20px; /* ä»14pxå¢åŠ åˆ°20pxï¼Œæé«˜è§¦æ§ç²¾åº¦ */
            height: 20px; /* ä»14pxå¢åŠ åˆ°20pxï¼Œæé«˜è§¦æ§ç²¾åº¦ */
            transform: translate(-50%, -50%);
            cursor: pointer;
            z-index: 10;
            /* æ·»åŠ è§¦æ§å‹å¥½çš„æ ·å¼ */
            touch-action: manipulation; /* ä¼˜åŒ–è§¦æ§å“åº” */
        }
        
        .intersection:hover::after {
            content: '';
            position: absolute;
            width: 24px; /* ä»20pxå¢åŠ åˆ°24px */
            height: 24px; /* ä»20pxå¢åŠ åˆ°24px */
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.1);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .piece {
            position: absolute;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 5;
            transition: all 0.3s;
        }
        
        .piece.ghost {
            width: 20px;
            height: 20px;
            border: 3px dashed #2c3e50;
            background: transparent;
        }
        
        .piece.player1 {
            width: 26px;
            height: 26px;
            background: #2c3e50;
            border: 3px solid #2c3e50;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        
        .piece.player2 {
            width: 26px;
            height: 26px;
            background: white;
            border: 3px solid #2c3e50;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        
        .piece.win {
            animation: pulse 1s infinite;
            box-shadow: 0 0 20px #FFD700, 0 0 30px #FFD700;
        }
        
        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }
        
        .coordinate-label {
            position: absolute;
            font-size: 14px;
            font-weight: bold;
            color: #8B4513;
            text-shadow: 1px 1px 0 white;
            z-index: 2;
        }
        
        .col-label {
            bottom: -20px;
            left: 0;
            transform: translateX(-50%);
            text-align: center;
            width: 14px;
        }
        
        .row-label {
            left: -20px;
            top: 0;
            transform: translateY(-50%);
            text-align: center;
            height: 14px;
            line-height: 14px;
        }
        
        .game-info {
            background: #F5F5DC;
            padding: 10px;
            border-radius: 10px;
            margin-top: 10px;
            border: 3px solid #8B4513;
            width: 100%;
            max-width: 340px;
            text-align: center;
        }
        
        .current-player {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #8B4513;
        }
        
        .teams {
            display: flex;
            justify-content: space-around;
            margin-bottom: 8px;
        }
        
        .team {
            text-align: center;
            padding: 8px 15px;
            border-radius: 8px;
            font-weight: bold;
            flex: 1;
            margin: 0 8px;
            border: 2px solid transparent;
            font-size: 14px;
        }
        
        .team.active {
            border: 2px solid #8B4513;
            background: rgba(139, 69, 19, 0.1);
        }
        
        .team.boys {
            background: #2c3e50;
            color: white;
        }
        
        .team.girls {
            background: white;
            color: #2c3e50;
            border: 2px solid #2c3e50;
        }
        
        .win-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            border-radius: 15px;
        }
        
        .win-message {
            color: #FFD700;
            font-size: 36px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.7);
        }
        
        .win-buttons {
            display: flex;
            gap: 15px;
        }
        
        .win-buttons button {
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 0 rgba(0,0,0,0.3);
        }
        
        .win-buttons button:hover {
            transform: translateY(2px);
            box-shadow: 0 2px 0 rgba(0,0,0,0.3);
        }
        
        .win-buttons button:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 rgba(0,0,0,0.3);
        }
        
        .play-again {
            background: #27ae60;
            color: white;
        }
        
        .new-game {
            background: #3498db;
            color: white;
        }
        
        .message {
            padding: 6px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            margin-top: 6px;
            min-height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
        }
        
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 1000px) {
            .game-container {
                max-width: 95%;
                margin: 0 auto;
            }
            
            .game-area {
                flex-wrap: wrap;
            }
            
            .input-section {
                min-width: 160px;
            }
            
            .board-section {
                order: -1;
                min-width: 100%;
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="header">
            <h1>âš« æ•°å¯¹å››å­æ£‹ âšª</h1>
        </div>
        
        <div class="game-area">
            <!-- å·¦ä¾§è¾“å…¥åŒºåŸŸ -->
            <div class="input-section">
                <div class="input-display" id="inputDisplay">
                    è¯·è¾“å…¥æ•°å¯¹
                </div>
                
                <div class="keypad">
                    <button class="key" onclick="pressKey('1')">1</button>
                    <button class="key" onclick="pressKey('2')">2</button>
                    <button class="key" onclick="pressKey('3')">3</button>
                    <button class="key" onclick="pressKey('4')">4</button>
                    <button class="key" onclick="pressKey('5')">5</button>
                    <button class="key" onclick="pressKey('6')">6</button>
                    <button class="key" onclick="pressKey('7')">7</button>
                    <button class="key" onclick="pressKey('8')">8</button>
                    <button class="key" onclick="pressKey('9')">9</button>
                    <button class="key" onclick="pressKey('0')">0</button>
                    <button class="key comma" onclick="pressKey(',')">,</button>
                    <button class="key" onclick="pressKey('â†')">â†</button>
                </div>
                
                <div class="action-buttons">
                    <button class="confirm" onclick="placePiece()">ç¡®å®šè½å­</button>
                    <button class="clear" onclick="clearInput()">æ¸…ç©º</button>
                    <button class="restart" onclick="restartGame()">é‡æ–°å¼€å§‹</button>
                </div>
            </div>
            
            <!-- ä¸­é—´æ£‹ç›˜åŒºåŸŸ -->
            <div class="board-section">
                <div class="board-container">
                    <div id="gameBoard">
                        <!-- æ£‹ç›˜å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                
                <div class="game-info">
                    <div class="teams">
                        <div class="team boys active" id="teamBoys">
                            <div>ç”·ç”Ÿé˜Ÿ</div>
                            <div>é»‘è‰²æ£‹å­</div>
                        </div>
                        <div class="team girls" id="teamGirls">
                            <div>å¥³ç”Ÿé˜Ÿ</div>
                            <div>ç™½è‰²æ£‹å­</div>
                        </div>
                    </div>
                    <div class="current-player" id="currentPlayer">
                        å½“å‰: ç”·ç”Ÿé˜Ÿè½å­
                    </div>
                    <div class="message" id="message"></div>
                </div>
            </div>
            
            <!-- å³ä¾§è¾“å…¥åŒºåŸŸ -->
            <div class="input-section">
                <div class="input-display" id="inputDisplayRight">
                    è¯·è¾“å…¥æ•°å¯¹
                </div>
                
                <div class="keypad">
                    <button class="key" onclick="pressKey('1', true)">1</button>
                    <button class="key" onclick="pressKey('2', true)">2</button>
                    <button class="key" onclick="pressKey('3', true)">3</button>
                    <button class="key" onclick="pressKey('4', true)">4</button>
                    <button class="key" onclick="pressKey('5', true)">5</button>
                    <button class="key" onclick="pressKey('6', true)">6</button>
                    <button class="key" onclick="pressKey('7', true)">7</button>
                    <button class="key" onclick="pressKey('8', true)">8</button>
                    <button class="key" onclick="pressKey('9', true)">9</button>
                    <button class="key" onclick="pressKey('0', true)">0</button>
                    <button class="key comma" onclick="pressKey(',', true)">,</button>
                    <button class="key" onclick="pressKey('â†', true)">â†</button>
                </div>
                
                <div class="action-buttons">
                    <button class="confirm" onclick="placePiece(true)">ç¡®å®šè½å­</button>
                    <button class="clear" onclick="clearInput(true)">æ¸…ç©º</button>
                    <button class="restart" onclick="restartGame()">é‡æ–°å¼€å§‹</button>
                </div>
            </div>
            
            <!-- è·èƒœé¡µé¢ -->
            <div class="win-overlay" id="winOverlay" style="display: none;">
                <div class="win-message" id="winMessage"></div>
                <div class="win-buttons">
                    <button class="play-again" onclick="playAgain()">å†ç©ä¸€æ¬¡</button>
                    <button class="new-game" onclick="newGame()">æ–°æ¸¸æˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- éŸ³æ•ˆå…ƒç´  -->
    <audio id="placeSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA==" type="audio/wav">
    </audio>
    <audio id="errorSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA==" type="audio/wav">
    </audio>
    <audio id="winSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA==" type="audio/wav">
    </audio>
    <audio id="clickSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA==" type="audio/wav">
    </audio>

    <script>
        // æ¸¸æˆçŠ¶æ€å˜é‡
        let currentPlayer = 1; // 1: ç”·ç”Ÿé˜Ÿ(é»‘), 2: å¥³ç”Ÿé˜Ÿ(ç™½)
        let gameBoard = [];
        const totalLines = 8; // 9æ¡æ¨ªçº¿å’Œ9æ¡ç«–çº¿ï¼Œå½¢æˆ9x9=81ä¸ªäº¤ç‚¹
        let gameActive = true;
        let currentInput = '';
        let selectedIntersection = null;
        const boardSize = 280; // æ£‹ç›˜å¤§å°ä»300pxç¼©å°åˆ°280px
        const cellSize = boardSize / totalLines; // æ¯ä¸ªæ ¼å­çš„å¤§å°
        let winningPieces = []; // å­˜å‚¨è·èƒœçš„æ£‹å­ä½ç½®

        // éŸ³æ•ˆå‡½æ•°
        function playSound(soundId) {
            const sound = document.getElementById(soundId);
            if (sound) {
                sound.currentTime = 0;
                sound.play().catch(e => console.log("éŸ³æ•ˆæ’­æ”¾å¤±è´¥:", e));
            }
        }

        // ç”Ÿæˆç®€å•éŸ³æ•ˆ
        function generateSounds() {
            // è½å­éŸ³æ•ˆ - çŸ­ä¿ƒçš„ç‚¹å‡»å£°
            const placeSound = document.getElementById('placeSound');
            placeSound.src = generateTone(800, 0.1);
            
            // é”™è¯¯éŸ³æ•ˆ - ä½æ²‰çš„é”™è¯¯æç¤ºå£°
            const errorSound = document.getElementById('errorSound');
            errorSound.src = generateTone(400, 0.3);
            
            // è·èƒœéŸ³æ•ˆ - æ¬¢å¿«çš„èƒœåˆ©éŸ³æ•ˆ
            const winSound = document.getElementById('winSound');
            winSound.src = generateTone(1200, 0.5);
            
            // ç‚¹å‡»éŸ³æ•ˆ - è½»å¾®çš„ç‚¹å‡»å£°
            const clickSound = document.getElementById('clickSound');
            clickSound.src = generateTone(600, 0.05);
        }

        // ç”Ÿæˆç®€å•éŸ³è°ƒ
        function generateTone(frequency, duration) {
            const sampleRate = 44100;
            const channels = 1;
            const samples = Math.floor(sampleRate * duration);
            
            // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const buffer = audioContext.createBuffer(channels, samples, sampleRate);
            const data = buffer.getChannelData(0);
            
            // ç”ŸæˆéŸ³è°ƒ
            for (let i = 0; i < samples; i++) {
                const t = i / sampleRate;
                // ä½¿ç”¨æ­£å¼¦æ³¢ç”ŸæˆéŸ³è°ƒï¼Œå¹¶æ·»åŠ è¡°å‡æ•ˆæœ
                data[i] = Math.sin(2 * Math.PI * frequency * t) * Math.exp(-t * 2);
            }
            
            // å°†éŸ³é¢‘ç¼“å†²åŒºè½¬æ¢ä¸ºWAVæ ¼å¼
            return bufferToWav(buffer);
        }

        // å°†éŸ³é¢‘ç¼“å†²åŒºè½¬æ¢ä¸ºWAVæ ¼å¼
        function bufferToWav(buffer) {
            const sampleRate = buffer.sampleRate;
            const channels = buffer.numberOfChannels;
            const samples = buffer.length;
            
            // åˆ›å»ºWAVæ–‡ä»¶å¤´
            const frameCount = samples * channels;
            const bufferLength = frameCount * 2 + 44;
            const arrayBuffer = new ArrayBuffer(bufferLength);
            const dataView = new DataView(arrayBuffer);
            
            // WAVæ–‡ä»¶å¤´
            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    dataView.setUint8(offset + i, string.charCodeAt(i));
                }
            };
            
            writeString(0, 'RIFF');
            dataView.setUint32(4, bufferLength - 8, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            dataView.setUint32(16, 16, true);
            dataView.setUint16(20, 1, true);
            dataView.setUint16(22, channels, true);
            dataView.setUint32(24, sampleRate, true);
            dataView.setUint32(28, sampleRate * channels * 2, true);
            dataView.setUint16(32, channels * 2, true);
            dataView.setUint16(34, 16, true);
            writeString(36, 'data');
            dataView.setUint32(40, frameCount * 2, true);
            
            // å†™å…¥éŸ³é¢‘æ•°æ®
            let offset = 44;
            for (let i = 0; i < samples; i++) {
                for (let channel = 0; channel < channels; channel++) {
                    const sample = Math.max(-1, Math.min(1, buffer.getChannelData(channel)[i]));
                    dataView.setInt16(offset, sample < 0 ? sample * 0x8000 : sample * 0x7FFF, true);
                    offset += 2;
                }
            }
            
            // è½¬æ¢ä¸ºbase64
            const blob = new Blob([arrayBuffer], {type: 'audio/wav'});
            return URL.createObjectURL(blob);
        }

        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            gameBoard = [];
            for (let i = 0; i <= totalLines; i++) {
                gameBoard[i] = [];
                for (let j = 0; j <= totalLines; j++) {
                    gameBoard[i][j] = 0;
                }
            }
            
            renderBoard();
            updateCurrentPlayer();
            gameActive = true;
            currentInput = '';
            updateInputDisplay();
            updateInputDisplay(true);
            clearSelection();
            hideWinOverlay();
            showMessage('');
        }

        // æ¸²æŸ“æ£‹ç›˜
        function renderBoard() {
            const container = document.getElementById('gameBoard');
            container.innerHTML = '';
            
            // ç»˜åˆ¶æ¨ªçº¿ - 9æ¡æ¨ªçº¿
            for (let i = 0; i <= totalLines; i++) {
                const line = document.createElement('div');
                line.className = 'grid-line horizontal-line';
                line.style.top = `${i * cellSize}px`;
                container.appendChild(line);
            }
            
            // ç»˜åˆ¶ç«–çº¿ - 9æ¡ç«–çº¿
            for (let j = 0; j <= totalLines; j++) {
                const line = document.createElement('div');
                line.className = 'grid-line vertical-line';
                line.style.left = `${j * cellSize}px`;
                container.appendChild(line);
            }
            
            // æ·»åŠ åˆ—åæ ‡æ ‡ç­¾ - ä»å·¦å¾€å³ï¼Œä»0å¼€å§‹
            for (let j = 0; j <= totalLines; j++) {
                const label = document.createElement('div');
                label.className = 'coordinate-label col-label';
                label.textContent = j; // ä»å·¦å¾€å³ï¼Œä»0å¼€å§‹
                label.style.left = `${j * cellSize}px`;
                label.style.bottom = `-20px`;
                container.appendChild(label);
            }
            
            // æ·»åŠ è¡Œåæ ‡æ ‡ç­¾ - ä»ä¸‹å¾€ä¸Šï¼Œä»0å¼€å§‹
            for (let i = 0; i <= totalLines; i++) {
                const label = document.createElement('div');
                label.className = 'coordinate-label row-label';
                label.textContent = totalLines - i; // ä»ä¸‹å¾€ä¸Šï¼Œä»0å¼€å§‹
                label.style.top = `${i * cellSize}px`;
                label.style.left = `-20px`;
                container.appendChild(label);
            }
            
            // åˆ›å»ºäº¤ç‚¹ - 9x9=81ä¸ªäº¤ç‚¹
            for (let i = 0; i <= totalLines; i++) {
                for (let j = 0; j <= totalLines; j++) {
                    const intersection = document.createElement('div');
                    intersection.className = 'intersection';
                    intersection.dataset.row = i;
                    intersection.dataset.col = j;
                    intersection.style.left = `${j * cellSize}px`;
                    intersection.style.top = `${i * cellSize}px`;
                    
                    intersection.addEventListener('click', () => {
                        playSound('clickSound');
                        handleIntersectionClick(i, j);
                    });
                    
                    // æ·»åŠ è§¦æ§äº‹ä»¶æ”¯æŒ
                    intersection.addEventListener('touchstart', (e) => {
                        e.preventDefault(); // é˜²æ­¢è§¦å‘clickäº‹ä»¶
                        playSound('clickSound');
                        handleIntersectionClick(i, j);
                    }, { passive: false });
                    
                    container.appendChild(intersection);
                }
            }
            
            // ç»˜åˆ¶å·²è½å­çš„æ£‹å­
            for (let i = 0; i <= totalLines; i++) {
                for (let j = 0; j <= totalLines; j++) {
                    if (gameBoard[i][j] !== 0) {
                        const piece = document.createElement('div');
                        piece.className = `piece player${gameBoard[i][j]}`;
                        
                        // å¦‚æœæ˜¯è·èƒœçš„æ£‹å­ï¼Œæ·»åŠ é«˜äº®æ•ˆæœ
                        if (isWinningPiece(i, j)) {
                            piece.classList.add('win');
                        }
                        
                        piece.style.left = `${j * cellSize}px`;
                        piece.style.top = `${i * cellSize}px`;
                        container.appendChild(piece);
                    }
                }
            }
        }

        // æ£€æŸ¥æ˜¯å¦ä¸ºè·èƒœæ£‹å­
        function isWinningPiece(row, col) {
            return winningPieces.some(piece => piece.row === row && piece.col === col);
        }

        // å¤„ç†äº¤ç‚¹ç‚¹å‡»
        function handleIntersectionClick(row, col) {
            if (!gameActive) return;
            
            // å¦‚æœè¯¥ä½ç½®å·²æœ‰æ£‹å­ï¼Œä¸èƒ½é€‰æ‹©
            if (gameBoard[row][col] !== 0) {
                showMessage('è¯¥ä½ç½®å·²æœ‰æ£‹å­ï¼', 'error');
                playSound('errorSound');
                return;
            }
            
            // æ¸…é™¤ä¹‹å‰çš„é€‰æ‹©
            clearSelection();
            
            // è®¾ç½®å½“å‰é€‰æ‹©
            selectedIntersection = { row, col };
            
            // åœ¨æ£‹ç›˜ä¸Šæ˜¾ç¤ºè™šæ‹Ÿæ£‹å­
            const container = document.getElementById('gameBoard');
            const ghostPiece = document.createElement('div');
            ghostPiece.className = `piece ghost player${currentPlayer}`;
            ghostPiece.id = 'ghostPiece';
            ghostPiece.style.left = `${col * cellSize}px`;
            ghostPiece.style.top = `${row * cellSize}px`;
            container.appendChild(ghostPiece);
            
            showMessage('');
        }

        // æ¸…é™¤é€‰æ‹©
        function clearSelection() {
            const ghostPiece = document.getElementById('ghostPiece');
            if (ghostPiece) {
                ghostPiece.remove();
            }
            selectedIntersection = null;
        }

        // æŒ‰é”®å¤„ç†
        function pressKey(key, isRightPanel = false) {
            if (!gameActive) return;
            
            playSound('clickSound');
            
            if (key === 'â†') {
                // é€€æ ¼é”®
                currentInput = currentInput.slice(0, -1);
            } else if (key === ',') {
                // é€—å·é”®ï¼Œåªèƒ½è¾“å…¥ä¸€æ¬¡
                if (!currentInput.includes(',')) {
                    currentInput += key;
                }
            } else {
                // æ•°å­—é”®
                currentInput += key;
            }
            
            updateInputDisplay(isRightPanel);
        }

        // æ›´æ–°è¾“å…¥æ˜¾ç¤º
        function updateInputDisplay(isRightPanel = false) {
            const displayId = isRightPanel ? 'inputDisplayRight' : 'inputDisplay';
            const display = document.getElementById(displayId);
            if (currentInput === '') {
                display.textContent = 'è¯·è¾“å…¥æ•°å¯¹';
            } else {
                display.textContent = currentInput;
            }
        }

        // æ¸…ç©ºè¾“å…¥
        function clearInput(isRightPanel = false) {
            playSound('clickSound');
            currentInput = '';
            updateInputDisplay(isRightPanel);
            showMessage('');
        }

        // è½å­
        function placePiece(isRightPanel = false) {
            if (!gameActive) return;
            
            playSound('clickSound');
            
            // å¦‚æœæ²¡æœ‰é€‰æ‹©äº¤ç‚¹
            if (!selectedIntersection) {
                showMessage('è¯·å…ˆç‚¹å‡»æ£‹ç›˜é€‰æ‹©ä¸€ä¸ªäº¤ç‚¹ï¼', 'error');
                playSound('errorSound');
                return;
            }
            
            // å¦‚æœæ²¡æœ‰è¾“å…¥æ•°å¯¹
            if (!currentInput.includes(',')) {
                showMessage('è¯·è¾“å…¥å®Œæ•´çš„æ•°å¯¹ï¼Œæ ¼å¼ï¼šåˆ—,è¡Œ', 'error');
                playSound('errorSound');
                return;
            }
            
            const coords = currentInput.split(',');
            if (coords.length !== 2) {
                showMessage('è¯·è¾“å…¥æ­£ç¡®çš„æ•°å¯¹æ ¼å¼ï¼Œå¦‚ï¼š3,4', 'error');
                playSound('errorSound');
                return;
            }
            
            const colInput = parseInt(coords[0]);
            const rowInput = parseInt(coords[1]);
            
            if (isNaN(rowInput) || isNaN(colInput)) {
                showMessage('åæ ‡å¿…é¡»æ˜¯æ•°å­—ï¼', 'error');
                playSound('errorSound');
                return;
            }
            
            // æ£€æŸ¥è¾“å…¥èŒƒå›´
            if (colInput < 0 || colInput > 8 || rowInput < 0 || rowInput > 8) {
                showMessage('åæ ‡èŒƒå›´æ˜¯0åˆ°8ï¼', 'error');
                playSound('errorSound');
                return;
            }
            
            // å°†ç”¨æˆ·è¾“å…¥çš„æ•°å¯¹è½¬æ¢ä¸ºå†…éƒ¨åæ ‡
            // åˆ—ï¼šä»å·¦å¾€å³ï¼Œä»0å¼€å§‹
            // è¡Œï¼šä»ä¸‹å¾€ä¸Šï¼Œä»0å¼€å§‹
            const col = colInput;
            const row = totalLines - rowInput;
            
            // æ£€æŸ¥æ•°å¯¹æ˜¯å¦ä¸é€‰æ‹©çš„äº¤ç‚¹ä¸€è‡´
            if (col !== selectedIntersection.col || row !== selectedIntersection.row) {
                showMessage(`æ•°å¯¹ä¸æ£‹å­ä½ç½®ä¸ä¸€è‡´ï¼æ‚¨è¾“å…¥çš„æ˜¯(${colInput},${rowInput})ï¼Œä½†æ£‹å­ä½ç½®æ˜¯(${selectedIntersection.col},${totalLines - selectedIntersection.row})`, 'error');
                playSound('errorSound');
                return;
            }
            
            // æ£€æŸ¥ä½ç½®æ˜¯å¦å¯ç”¨
            if (gameBoard[row][col] !== 0) {
                showMessage('è¯¥ä½ç½®å·²æœ‰æ£‹å­ï¼', 'error');
                playSound('errorSound');
                return;
            }
            
            // è½å­
            gameBoard[row][col] = currentPlayer;
            playSound('placeSound');
            
            // æ£€æŸ¥æ˜¯å¦è·èƒœ
            const winResult = checkWin(row, col);
            if (winResult.win) {
                winningPieces = winResult.pieces;
                renderBoard();
                showWinMessage(currentPlayer === 1 ? 'ç”·ç”Ÿé˜Ÿ' : 'å¥³ç”Ÿé˜Ÿ');
                playSound('winSound');
                gameActive = false;
                return;
            }
            
            if (checkDraw()) {
                renderBoard();
                showWinMessage('å¹³å±€ï¼');
                gameActive = false;
                return;
            }
            
            // åˆ‡æ¢ç©å®¶
            currentPlayer = currentPlayer === 1 ? 2 : 1;
            updateCurrentPlayer();
            
            // é‡ç½®è¾“å…¥å’Œé€‰æ‹©
            currentInput = '';
            updateInputDisplay();
            updateInputDisplay(true); // åŒæ—¶æ›´æ–°å³ä¾§æ˜¾ç¤º
            selectedIntersection = null;
            
            renderBoard();
            showMessage('');
        }

        // æ£€æŸ¥è·èƒœ
        function checkWin(row, col) {
            const player = gameBoard[row][col];
            const directions = [
                [0, 1],   // æ°´å¹³
                [1, 0],   // å‚ç›´
                [1, 1],   // å³ä¸‹å¯¹è§’çº¿
                [1, -1]   // å·¦ä¸‹å¯¹è§’çº¿
            ];
            
            for (const [dx, dy] of directions) {
                const pieces = [{row, col}];
                
                // æ­£å‘æ£€æŸ¥
                for (let i = 1; i <= 3; i++) {
                    const newRow = row + dx * i;
                    const newCol = col + dy * i;
                    if (newRow >= 0 && newRow <= totalLines && newCol >= 0 && newCol <= totalLines && 
                        gameBoard[newRow][newCol] === player) {
                        pieces.push({row: newRow, col: newCol});
                    } else {
                        break;
                    }
                }
                
                // åå‘æ£€æŸ¥
                for (let i = 1; i <= 3; i++) {
                    const newRow = row - dx * i;
                    const newCol = col - dy * i;
                    if (newRow >= 0 && newRow <= totalLines && newCol >= 0 && newCol <= totalLines && 
                        gameBoard[newRow][newCol] === player) {
                        pieces.push({row: newRow, col: newCol});
                    } else {
                        break;
                    }
                }
                
                if (pieces.length >= 4) {
                    return {win: true, pieces: pieces};
                }
            }
            
            return {win: false, pieces: []};
        }

        // æ£€æŸ¥å¹³å±€
        function checkDraw() {
            for (let i = 0; i <= totalLines; i++) {
                for (let j = 0; j <= totalLines; j++) {
                    if (gameBoard[i][j] === 0) {
                        return false;
                    }
                }
            }
            return true;
        }

        // æ›´æ–°å½“å‰ç©å®¶æ˜¾ç¤º
        function updateCurrentPlayer() {
            const playerElement = document.getElementById('currentPlayer');
            const teamBoys = document.getElementById('teamBoys');
            const teamGirls = document.getElementById('teamGirls');
            
            if (currentPlayer === 1) {
                playerElement.innerHTML = 'å½“å‰: ç”·ç”Ÿé˜Ÿè½å­';
                teamBoys.classList.add('active');
                teamGirls.classList.remove('active');
            } else {
                playerElement.innerHTML = 'å½“å‰: å¥³ç”Ÿé˜Ÿè½å­';
                teamGirls.classList.add('active');
                teamBoys.classList.remove('active');
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(text, type) {
            const messageElement = document.getElementById('message');
            messageElement.textContent = text;
            if (type === 'error') {
                messageElement.className = 'message error';
            } else {
                messageElement.className = 'message';
                messageElement.style.background = 'transparent';
                messageElement.style.border = 'none';
            }
        }

        // æ˜¾ç¤ºè·èƒœæ¶ˆæ¯
        function showWinMessage(winner) {
            const winOverlay = document.getElementById('winOverlay');
            const winMessage = document.getElementById('winMessage');
            
            winMessage.textContent = winner === 'å¹³å±€ï¼' ? 'å¹³å±€ï¼' : `ğŸ‰ ${winner} è·èƒœï¼ ğŸ‰`;
            winOverlay.style.display = 'flex';
        }

        // éšè—è·èƒœé¡µé¢
        function hideWinOverlay() {
            const winOverlay = document.getElementById('winOverlay');
            winOverlay.style.display = 'none';
            winningPieces = [];
        }

        // å†ç©ä¸€æ¬¡
        function playAgain() {
            playSound('clickSound');
            hideWinOverlay();
            restartGame();
        }

        // æ–°æ¸¸æˆ
        function newGame() {
            playSound('clickSound');
            hideWinOverlay();
            restartGame();
        }

        // é‡æ–°å¼€å§‹æ¸¸æˆ
        function restartGame() {
            playSound('clickSound');
            currentPlayer = 1;
            initGame();
        }

        // æ·»åŠ è§¦æ§äº‹ä»¶æ”¯æŒå‡½æ•°
        function addTouchSupport() {
            // ä¸ºæ‰€æœ‰æŒ‰é’®æ·»åŠ è§¦æ§äº‹ä»¶
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                // è·å–åŸæœ‰çš„onclickå‡½æ•°
                const onclickHandler = button.getAttribute('onclick');
                if (onclickHandler) {
                    button.addEventListener('touchstart', (e) => {
                        e.preventDefault(); // é˜²æ­¢è§¦å‘clickäº‹ä»¶
                        // æ‰§è¡ŒåŸæœ‰çš„onclickå‡½æ•°
                        eval(onclickHandler);
                    }, { passive: false });
                }
            });
        }

        // åˆå§‹åŒ–æ¸¸æˆå’ŒéŸ³æ•ˆ
        window.onload = function() {
            generateSounds();
            initGame();
            addTouchSupport(); // æ·»åŠ è§¦æ§æ”¯æŒ
        };
    </script>
</body>
</html>