<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èƒŒè¯µå†’é™©è®°</title>
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="game-container">
        <div class="current-task-display" id="currentTaskDisplay">
            <!-- å½“å‰ä»»åŠ¡ä¿¡æ¯å°†é€šè¿‡JSåŠ¨æ€æ›´æ–° -->
        </div>
        <div class="controls game-ui">
            <div class="add-character">
                <input type="text" id="newStudentName" placeholder="è¾“å…¥å†’é™©è€…å§“å">
                <button onclick="addNewStudent()" class="game-btn">æ·»åŠ å†’é™©è€…</button>
                <div class="import-wrapper">
                    <button onclick="document.getElementById('importFile').click()" class="game-btn">
                        <span>æ‰¹é‡å¯¼å…¥</span>
                    </button>
                    <input type="file" id="importFile" accept=".xlsx,.xls,.csv,.txt" style="display: none" onchange="importStudents(this)">
                </div>
            </div>
            <div class="task-controls">
                <button onclick="showTaskModal()" class="game-btn task-btn">
                    ç®¡ç†èƒŒè¯µä»»åŠ¡
                </button>
            </div>
            <div class="save-export">
                <button onclick="exportData()" class="game-btn">å¯¼å‡ºè®°å½•</button>
                <button onclick="resetStudents()" class="game-btn reset-btn">é‡ç½®ä½ç½®</button>
                <button onclick="resetAdventure()" class="game-btn danger-btn">é‡ç½®å†’é™©</button>
            </div>
        </div>
        <div class="game-world">
            <div class="palace-area">
                <h2 class="area-title">çŸ¥è¯†å®«æ®¿</h2>
                <div class="character-list palace" id="completed" ondrop="drop(event)" ondragover="allowDrop(event)" ondragleave="dragLeave(event)">
                    <!-- å·²å®ŒæˆèƒŒè¯µçš„è§’è‰²ä¼šå‡ºç°åœ¨è¿™é‡Œ -->
                </div>
            </div>
            <div class="wilderness-area">
                <h2 class="area-title">ä¿®ç‚¼é‡å¤–</h2>
                <div id="disguiseBox" class="disguise-box" ondrop="dropForDisguise(event)" ondragover="allowDrop(event)" ondragleave="dragLeave(event)" title="å°†å†’é™©è€…å¤´åƒæ‹–åˆ°æ­¤å¤„ï¼Œä½¿ç”¨æ˜“å®¹æœ¯æ›´æ¢å¤´åƒ">
                    <!-- æ˜“å®¹æœ¯æ–¹æ¡† -->
                </div>
                <div class="character-list wilderness" id="pending" ondrop="drop(event)" ondragover="allowDrop(event)" ondragleave="dragLeave(event)">
                    <!-- åˆå§‹ç¤ºä¾‹å­¦ç”Ÿ -->
                    <div class="character-card" draggable="true" ondragstart="drag(event)" id="student1">
                        <div class="character-avatar">
                            <img src="images/avatar1.png" alt="è§’è‰²å¤´åƒ">
                        </div>
                        <span class="character-name">å¼ ä¸‰</span>
                    </div>
                    <div class="character-card" draggable="true" ondragstart="drag(event)" id="student2">
                        <div class="character-avatar">
                            <img src="images/avatar2.png" alt="è§’è‰²å¤´åƒ">
                        </div>
                        <span class="character-name">æå››</span>
                    </div>
                    <div class="character-card" draggable="true" ondragstart="drag(event)" id="student3">
                        <div class="character-avatar">
                            <img src="images/avatar3.png" alt="è§’è‰²å¤´åƒ">
                        </div>
                        <span class="character-name">ç‹äº”</span>
                    </div>
                    <div class="character-card" draggable="true" ondragstart="drag(event)" id="student4">
                        <div class="character-avatar">
                            <img src="images/avatar4.png" alt="è§’è‰²å¤´åƒ">
                        </div>
                        <span class="character-name">èµµå…­</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å°†æ¨¡æ€æ¡†ç§»åˆ°è¿™é‡Œ -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>èƒŒè¯µä»»åŠ¡ç®¡ç†</h2>
                <span class="close" onclick="closeTaskModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="task-input">
                    <input type="text" id="newTaskName" placeholder="è¾“å…¥ä»»åŠ¡åç§°ï¼ˆå¦‚ï¼šç¬¬ä¸€å•å…ƒè¯¾æ–‡èƒŒè¯µï¼‰">
                    <button onclick="addTask()" class="game-btn">æ·»åŠ ä»»åŠ¡</button>
                </div>
                <div class="task-list" id="taskList">
                    <!-- ä»»åŠ¡åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>

    <!-- å¤´åƒé€‰æ‹©æ¨¡æ€æ¡† -->
    <div id="avatarSelection" class="avatar-selection">
        <div class="avatar-selection-content">
            <div class="avatar-selection-header">
                <h2>é€‰æ‹©æ–°å¤´åƒ</h2>
                <span class="close" onclick="closeAvatarSelection()">&times;</span>
            </div>
            <div class="avatar-grid" id="avatarGrid">
                <!-- å¤´åƒé€‰é¡¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <script>
        function allowDrop(ev) {
            ev.preventDefault();
            // è·å–æ”¾ç½®åŒºåŸŸ
            const dropZone = ev.currentTarget;
            if (dropZone && (dropZone.classList.contains('character-list') || dropZone.classList.contains('disguise-box'))) {
                dropZone.classList.add('drag-over');
            }
        }

        function drag(ev) {
            // è·å–è¢«æ‹–æ‹½çš„å¡ç‰‡
            const card = ev.target.closest('.character-card');
            if (!card) return;

            // è®¾ç½®æ‹–æ‹½æ•°æ®
            ev.dataTransfer.setData("text/plain", card.id);
            card.classList.add('dragging');
            
            // è®¾ç½®å…è®¸çš„æ‹–æ‹½æ•ˆæœ
            ev.dataTransfer.effectAllowed = "move";

            // åˆ›å»ºæ‹–æ‹½é¢„è§ˆ
            const dragImage = document.createElement('div');
            dragImage.className = 'drag-preview';
            
            const avatar = card.querySelector('.character-avatar').cloneNode(true);
            const name = card.querySelector('.character-name').cloneNode(true);
            
            dragImage.appendChild(avatar);
            dragImage.appendChild(name);
            
            document.body.appendChild(dragImage);
            ev.dataTransfer.setDragImage(dragImage, 30, 30);
            setTimeout(() => document.body.removeChild(dragImage), 0);
            
            // é˜²æ­¢äº‹ä»¶å†’æ³¡
            ev.stopPropagation();
        }

        function drop(ev) {
            ev.preventDefault();
            
            // è·å–æ”¾ç½®åŒºåŸŸ
            const dropZone = ev.currentTarget;
            if (!dropZone.classList.contains('character-list')) return;

            // è·å–è¢«æ‹–æ‹½å…ƒç´ 
            const data = ev.dataTransfer.getData("text/plain");
            const draggedElement = document.getElementById(data);
            if (!draggedElement) return;

            // ç§»é™¤æ‹–æ‹½ç›¸å…³çš„ç±»
            document.querySelectorAll('.drag-over').forEach(zone => {
                zone.classList.remove('drag-over');
            });
            draggedElement.classList.remove('dragging');

            // æ£€æŸ¥æ˜¯å¦ä»æœªå®ŒæˆåŒºåŸŸæ‹–æ‹½åˆ°å®ŒæˆåŒºåŸŸ
            const isMovingToCompleted = dropZone.id === 'completed';
            const wasInPending = draggedElement.parentElement && draggedElement.parentElement.id === 'pending';
            
            // æ·»åŠ åˆ°æ–°ä½ç½®
            dropZone.appendChild(draggedElement);

            // å¦‚æœæ˜¯æ–°å®Œæˆä»»åŠ¡ï¼Œåˆ†é…å¥–ç‰Œ
            if (isMovingToCompleted && wasInPending) {
                assignMedal(draggedElement);
            }

            // æ·»åŠ æ”¾ç½®åŠ¨ç”»
            draggedElement.classList.add('dropped');
            setTimeout(() => {
                draggedElement.classList.remove('dropped');
            }, 300);
            
            // è‡ªåŠ¨ä¿å­˜è¿›åº¦
            saveData();
        }

        // æ˜“å®¹æœ¯åŠŸèƒ½ï¼šæ‹–åŠ¨åˆ°æ˜“å®¹æœ¯æ–¹æ¡†
        function dropForDisguise(ev) {
            ev.preventDefault();
            
            // è·å–æ”¾ç½®åŒºåŸŸ
            const dropZone = ev.currentTarget;
            if (!dropZone.classList.contains('disguise-box')) return;

            // è·å–è¢«æ‹–æ‹½å…ƒç´ 
            const data = ev.dataTransfer.getData("text/plain");
            const draggedElement = document.getElementById(data);
            if (!draggedElement) return;

            // ç§»é™¤æ‹–æ‹½ç›¸å…³çš„ç±»
            document.querySelectorAll('.drag-over').forEach(zone => {
                zone.classList.remove('drag-over');
            });
            draggedElement.classList.remove('dragging');

            // ä¿å­˜å½“å‰é€‰ä¸­çš„å­¦ç”ŸID
            window.currentStudentId = data;

            // æ˜¾ç¤ºå¤´åƒé€‰æ‹©æ¨¡æ€æ¡†
            showAvatarSelection();
            
            // è‡ªåŠ¨ä¿å­˜è¿›åº¦
            saveData();
        }

        // æ˜¾ç¤ºå¤´åƒé€‰æ‹©æ¨¡æ€æ¡†
        function showAvatarSelection() {
            const avatarSelection = document.getElementById('avatarSelection');
            const avatarGrid = document.getElementById('avatarGrid');
            
            // æ¸…ç©ºä¹‹å‰çš„å¤´åƒé€‰é¡¹
            avatarGrid.innerHTML = '';
            
            // æ·»åŠ æ‰€æœ‰å¤´åƒé€‰é¡¹
            const avatars = [
                'avatar1.png', 'avatar2.png', 'avatar3.png', 'avatar4.png',
                'avatar5.png', 'avatar6.png', 'avatar7.png', 'avatar8.png',
                'avatar9.png', 'avatar10.png', 'avatar11.png', 'avatar12.png',
                'avatar13.png', 'avatar14.png', 'avatar15.png', 'avatar16.png'
            ];
            
            avatars.forEach(avatar => {
                const avatarOption = document.createElement('div');
                avatarOption.className = 'avatar-option';
                avatarOption.innerHTML = `<img src="images/${avatar}" alt="å¤´åƒé€‰é¡¹">`;
                avatarOption.onclick = function() {
                    changeAvatar(`images/${avatar}`);
                };
                avatarGrid.appendChild(avatarOption);
            });
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            avatarSelection.style.display = 'flex';
        }

        // å…³é—­å¤´åƒé€‰æ‹©æ¨¡æ€æ¡†
        function closeAvatarSelection() {
            const avatarSelection = document.getElementById('avatarSelection');
            avatarSelection.style.display = 'none';
            window.currentStudentId = null;
        }

        // æ›´æ¢å¤´åƒå‡½æ•°ä¿®æ”¹ï¼Œç¡®ä¿å…¨å±€æ›´æ–°å¤´åƒä¿¡æ¯
        function changeAvatar(newAvatarPath) {
            if (!window.currentStudentId) return;
            
            const studentElement = document.getElementById(window.currentStudentId);
            if (!studentElement) return;
            
            // è·å–å¤´åƒå›¾ç‰‡å…ƒç´ 
            const avatarImg = studentElement.querySelector('.character-avatar img');
            const avatarContainer = studentElement.querySelector('.character-avatar');
            
            // æ·»åŠ åŠ¨ç”»æ•ˆæœ
            avatarContainer.classList.add('avatar-changing');
            
            // æå–å­¦ç”ŸIDå’Œå§“åï¼Œç”¨äºå…¨å±€æ›´æ–°
            const studentId = studentElement.id;
            const studentName = studentElement.querySelector('.character-name').textContent;
            
            // å»¶è¿Ÿæ›´æ¢å¤´åƒï¼Œè®©åŠ¨ç”»æœ‰æ—¶é—´æ˜¾ç¤º
            setTimeout(() => {
                avatarImg.src = newAvatarPath;
                
                // æå–å¤´åƒæ–‡ä»¶å
                const fileName = newAvatarPath.split('/').pop();
                const standardPath = `images/${fileName}`;
                
                // æ›´æ–°å…¨å±€å¤´åƒä¿¡æ¯
                updateGlobalStudentAvatar(studentId, studentName, standardPath);
                
                // ä¿å­˜å½“å‰ä»»åŠ¡çŠ¶æ€
                saveCurrentTaskState();
            }, 400);
            
            // åŠ¨ç”»ç»“æŸåç§»é™¤åŠ¨ç”»ç±»
            setTimeout(() => {
                avatarContainer.classList.remove('avatar-changing');
                studentElement.classList.add('dropped');
                
                setTimeout(() => {
                    studentElement.classList.remove('dropped');
                }, 300);
            }, 800);
            
            // å…³é—­æ¨¡æ€æ¡†
            closeAvatarSelection();
            
            // æ˜¾ç¤ºé€šçŸ¥
            showNotification('æ˜“å®¹æœ¯æ–½å±•æˆåŠŸï¼');
        }
        
        // æ”¹è¿›ç‰ˆçš„å…¨å±€å¤´åƒæ›´æ–°å‡½æ•°
        function updateGlobalStudentAvatar(studentId, studentName, avatarPath) {
            // è·å–æ‰€æœ‰ä»»åŠ¡
            const allTasks = JSON.parse(localStorage.getItem('recitationTasks') || '[]');
            let updated = false;
            
            // éå†æ‰€æœ‰ä»»åŠ¡
            allTasks.forEach(task => {
                // æ›´æ–°å·²å®Œæˆåˆ—è¡¨ä¸­çš„å­¦ç”Ÿå¤´åƒ
                task.completed = task.completed.map(student => {
                    if (student.id === studentId || 
                        (student.name === studentName && !student.id)) {
                        return {...student, avatar: avatarPath, id: studentId};
                    }
                    return student;
                });
                
                // æ›´æ–°æœªå®Œæˆåˆ—è¡¨ä¸­çš„å­¦ç”Ÿå¤´åƒ
                task.pending = task.pending.map(student => {
                    if (student.id === studentId || 
                        (student.name === studentName && !student.id)) {
                        return {...student, avatar: avatarPath, id: studentId};
                    }
                    return student;
                });
                
                updated = true;
            });
            
            // ä¿å­˜æ›´æ–°åçš„æ•°æ®
            if (updated) {
                localStorage.setItem('recitationTasks', JSON.stringify(allTasks));
            }
        }

        function dragLeave(ev) {
            const dropZone = ev.currentTarget;
            if (dropZone && (dropZone.classList.contains('character-list') || dropZone.classList.contains('disguise-box'))) {
                dropZone.classList.remove('drag-over');
            }
        }

        // å¥–ç‰Œåˆ†é…å‡½æ•°
        function assignMedal(studentElement) {
            // ç§»é™¤å·²æœ‰çš„å¥–ç‰Œ
            const existingMedal = studentElement.querySelector('.medal');
            if (existingMedal) {
                existingMedal.remove();
            }
            
            // è·å–å®ŒæˆåŒºåŸŸçš„å­¦ç”Ÿæ•°é‡ï¼ˆåŒ…æ‹¬åˆšæ·»åŠ çš„è¿™ä¸ªï¼‰
            const completedArea = document.getElementById('completed');
            const completedCount = completedArea.children.length;
            
            let medalType = '';
            
            // æ ¹æ®å®Œæˆé¡ºåºåˆ†é…å¥–ç‰Œ
            if (completedCount <= 5) {
                medalType = 'gold';
            } else if (completedCount <= 15) {
                medalType = 'silver';
            } else if (completedCount <= 30) {
                medalType = 'bronze';
            }
            
            // å¦‚æœæœ‰å¥–ç‰Œï¼Œåˆ›å»ºå¹¶æ·»åŠ 
            if (medalType) {
                const medal = document.createElement('div');
                medal.className = `medal ${medalType}`;
                medal.title = `ç¬¬${completedCount}åå®Œæˆ - ${medalType === 'gold' ? 'é‡‘ç‰Œ' : medalType === 'silver' ? 'é“¶ç‰Œ' : 'é“œç‰Œ'}`;
                
                // æ·»åŠ åˆ°å­¦ç”Ÿå¡ç‰‡
                studentElement.style.position = 'relative';
                studentElement.appendChild(medal);
                
                // æ˜¾ç¤ºå¥–ç‰Œè·å¾—é€šçŸ¥
                const studentName = studentElement.querySelector('.character-name').textContent;
                const medalName = medalType === 'gold' ? 'é‡‘ç‰Œ' : medalType === 'silver' ? 'é“¶ç‰Œ' : 'é“œç‰Œ';
                showNotification(`ğŸ‰ ${studentName} è·å¾—${medalName}ï¼ç¬¬${completedCount}åå®Œæˆä»»åŠ¡ï¼`);
            }
        }
        
        // æ›´æ–°æ‰€æœ‰å­¦ç”Ÿçš„å¥–ç‰Œï¼ˆç”¨äºåŠ è½½ä»»åŠ¡æ—¶ï¼‰
        function updateAllMedals() {
            const completedArea = document.getElementById('completed');
            const students = Array.from(completedArea.children);
            
            students.forEach((student, index) => {
                // ç§»é™¤å·²æœ‰çš„å¥–ç‰Œ
                const existingMedal = student.querySelector('.medal');
                if (existingMedal) {
                    existingMedal.remove();
                }
                
                const position = index + 1;
                let medalType = '';
                
                // æ ¹æ®ä½ç½®åˆ†é…å¥–ç‰Œ
                if (position <= 5) {
                    medalType = 'gold';
                } else if (position <= 15) {
                    medalType = 'silver';
                } else if (position <= 30) {
                    medalType = 'bronze';
                }
                
                // å¦‚æœæœ‰å¥–ç‰Œï¼Œåˆ›å»ºå¹¶æ·»åŠ 
                if (medalType) {
                    const medal = document.createElement('div');
                    medal.className = `medal ${medalType}`;
                    medal.title = `ç¬¬${position}åå®Œæˆ - ${medalType === 'gold' ? 'é‡‘ç‰Œ' : medalType === 'silver' ? 'é“¶ç‰Œ' : 'é“œç‰Œ'}`;
                    
                    // æ·»åŠ åˆ°å­¦ç”Ÿå¡ç‰‡
                    student.style.position = 'relative';
                    student.appendChild(medal);
                }
            });
        }

        // ä¿®æ”¹è·å–å¤´åƒçš„å‡½æ•°ï¼Œæ”¹ä¸ºéšæœºåˆ†é…è€Œä¸æ˜¯å¾ªç¯åˆ†é…
        function getNextAvatar() {
            const avatars = [
                'avatar1.png', 'avatar2.png', 'avatar3.png', 'avatar4.png',
                'avatar5.png', 'avatar6.png', 'avatar7.png', 'avatar8.png',
                'avatar9.png', 'avatar10.png', 'avatar11.png', 'avatar12.png',
                'avatar13.png', 'avatar14.png', 'avatar15.png', 'avatar16.png'
            ];
            const randomIndex = Math.floor(Math.random() * avatars.length);
            const avatarPath = `images/${avatars[randomIndex]}`;
            return avatarPath;
        }

        // åˆ›å»ºå­¦ç”Ÿå…ƒç´ å‡½æ•°ï¼Œä¼˜åŒ–å¤´åƒå¤„ç†
        function createStudentElement(student) {
            const characterCard = document.createElement('div');
            characterCard.className = 'character-card';
            characterCard.draggable = true;
            characterCard.id = student.id || 'student' + Date.now() + Math.random().toString(36).substr(2, 9);
            
            // ç¡®ä¿å¤´åƒè·¯å¾„æ­£ç¡®
            let avatarPath = student.avatar;
            
            if (!avatarPath) {
                // å¦‚æœæ²¡æœ‰å¤´åƒï¼Œéšæœºåˆ†é…ä¸€ä¸ª
                avatarPath = getNextAvatar();
            } else if (typeof avatarPath === 'string') {
                // å¤„ç†å¤´åƒè·¯å¾„ï¼Œç»Ÿä¸€æ ¼å¼ä¸º images/avatarX.png
                if (avatarPath.includes('/')) {
                    // ä»å®Œæ•´URLä¸­æå–æ–‡ä»¶å
                    const fileName = avatarPath.split('/').pop();
                    if (fileName && fileName.match(/avatar\d+\.png/)) {
                        avatarPath = `images/${fileName}`;
                    } else {
                        avatarPath = getNextAvatar();
                    }
                } else if (avatarPath.match(/avatar\d+\.png/)) {
                    // å¦‚æœåªæœ‰æ–‡ä»¶åï¼Œæ·»åŠ è·¯å¾„å‰ç¼€
                    avatarPath = `images/${avatarPath}`;
                } else {
                    avatarPath = getNextAvatar();
                }
            } else {
                avatarPath = getNextAvatar();
            }
            
            characterCard.innerHTML = `
                <div class="character-avatar">
                    <img src="${avatarPath}" 
                         alt="è§’è‰²å¤´åƒ" 
                         onerror="this.src='images/avatar1.png'">
                </div>
                <span class="character-name">${student.name}</span>
            `;
            
            characterCard.ondragstart = function(event) {
                drag(event);
            };
            return characterCard;
        }

        // ä¿®æ”¹æ·»åŠ æ–°å­¦ç”Ÿçš„å‡½æ•°
        function addNewStudent() {
            const nameInput = document.getElementById('newStudentName');
            const name = nameInput.value.trim();
            
            if (name) {
                // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨åŒåå­¦ç”Ÿï¼Œå¦‚æœå­˜åœ¨åˆ™ä½¿ç”¨ç›¸åŒçš„å¤´åƒ
                const existingStudent = findStudentByName(name);
                const studentId = 'student' + Date.now() + Math.random().toString(36).substr(2, 9);
                
                const studentData = {
                    id: studentId,
                    name: name,
                    avatar: existingStudent ? existingStudent.avatar : getNextAvatar()
                };
                
                const pendingList = document.getElementById('pending');
                const studentDiv = createStudentElement(studentData);
                pendingList.appendChild(studentDiv);
                
                // æ›´æ–°æ‰€æœ‰ä»»åŠ¡ä»¥ä¿æŒä¸€è‡´æ€§
                if (!existingStudent) {
                    updateGlobalStudentAvatar(studentId, name, studentData.avatar);
                }
                
                nameInput.value = '';
                showNotification(`å†’é™©è€… ${name} å·²è¢«å¬å”¤ï¼`);
                
                // ä¿å­˜å½“å‰ä»»åŠ¡çŠ¶æ€
                saveCurrentTaskState();
                // è‡ªåŠ¨ä¿å­˜è¿›åº¦
                saveData();
            } else {
                alert('è¯·è¾“å…¥å†’é™©è€…å§“å');
            }
        }
        
        // æŸ¥æ‰¾æ‰€æœ‰ä»»åŠ¡ä¸­æ˜¯å¦å­˜åœ¨åŒåå­¦ç”Ÿ
        function findStudentByName(name) {
            const allTasks = JSON.parse(localStorage.getItem('recitationTasks') || '[]');
            if (!allTasks.length) return null;
            
            for (const task of allTasks) {
                // åœ¨å·²å®ŒæˆåŒºåŸŸæŸ¥æ‰¾
                const completedStudent = task.completed.find(s => s.name === name);
                if (completedStudent) return completedStudent;
                
                // åœ¨æœªå®ŒæˆåŒºåŸŸæŸ¥æ‰¾
                const pendingStudent = task.pending.find(s => s.name === name);
                if (pendingStudent) return pendingStudent;
            }
            
            return null;
        }

        // ä¿®æ”¹æ·»åŠ å­¦ç”Ÿåˆ°åˆ—è¡¨çš„å‡½æ•°
        function addStudentsToList(names) {
            const pendingList = document.getElementById('pending');
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯åˆå§‹ç¤ºä¾‹å­¦ç”Ÿ
            const isInitialState = pendingList.children.length === 4 && 
                Array.from(pendingList.children).every((child, index) => {
                    const defaultNames = ['å¼ ä¸‰', 'æå››', 'ç‹äº”', 'èµµå…­'];
                    return child.querySelector('.character-name').textContent === defaultNames[index];
                });
            
            // å¦‚æœæ˜¯åˆå§‹çŠ¶æ€ï¼Œæ¸…ç©ºåˆ—è¡¨
            if (isInitialState) {
                pendingList.innerHTML = '';
            }
            
            // è¿‡æ»¤å¹¶å¤„ç†æœ‰æ•ˆçš„åå­—
            const validNames = names.filter(name => name && name.trim().length > 0);
            const addedStudents = [];
            
            validNames.forEach(name => {
                const trimmedName = name.trim();
                
                // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨åŒåå­¦ç”Ÿï¼Œå¦‚æœå­˜åœ¨åˆ™ä½¿ç”¨ç›¸åŒçš„å¤´åƒ
                const existingStudent = findStudentByName(trimmedName);
                const studentId = 'student' + Date.now() + Math.random().toString(36).substr(2, 9);
                
                const studentData = {
                    id: studentId,
                    name: trimmedName,
                    avatar: existingStudent ? existingStudent.avatar : getNextAvatar()
                };
                
                const studentDiv = createStudentElement(studentData);
                pendingList.appendChild(studentDiv);
                addedStudents.push(studentData);
            });
            
            // æ‰¹é‡æ›´æ–°æ‰€æœ‰æ–°æ·»åŠ çš„å­¦ç”Ÿ
            if (addedStudents.length > 0) {
                addedStudents.forEach(student => {
                    if (!findStudentByName(student.name) || 
                        findStudentByName(student.name).id === student.id) {
                        updateGlobalStudentAvatar(student.id, student.name, student.avatar);
                    }
                });
                
                // ä¿å­˜å½“å‰ä»»åŠ¡çŠ¶æ€
                saveCurrentTaskState();
            }
            
            showNotification(`æˆåŠŸå¯¼å…¥ ${validNames.length} åå­¦ç”Ÿ`);
        }

        // ä¿®æ”¹ä¿å­˜æ•°æ®çš„å‡½æ•°ï¼Œæ·»åŠ å¤´åƒä¿¡æ¯
        function saveData() {
            // ä¿å­˜å½“å‰ä»»åŠ¡çŠ¶æ€
            saveCurrentTaskState();
            showNotification('è¿›åº¦å·²ä¿å­˜');
            
            // ç¡®ä¿æ‰€æœ‰å­¦ç”Ÿçš„å¤´åƒä¿¡æ¯éƒ½è¢«æ­£ç¡®ä¿å­˜
            const allTasks = JSON.parse(localStorage.getItem('recitationTasks') || '[]');
            if (allTasks.length > 0) {
                localStorage.setItem('recitationTasks', JSON.stringify(allTasks));
            }
        }

        // å¯¼å‡ºæ•°æ®ä¸ºCSVæ–‡ä»¶
        function exportData() {
            const completed = document.getElementById('completed');
            const pending = document.getElementById('pending');
            
            let csvContent = "çŠ¶æ€,å­¦ç”Ÿå§“å,å¤´åƒ\n";
            
            Array.from(completed.children).forEach(student => {
                csvContent += `å·²èƒŒè¯µ,${student.innerText},${student.querySelector('.character-avatar img').src}\n`;
            });
            
            Array.from(pending.children).forEach(student => {
                csvContent += `æœªèƒŒè¯µ,${student.innerText},${student.querySelector('.character-avatar img').src}\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            
            link.setAttribute("href", url);
            link.setAttribute("download", "èƒŒè¯µè®°å½•.csv");
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ä¿®æ”¹é¡µé¢åŠ è½½æ—¶æ¢å¤æ•°æ®çš„å‡½æ•°
        window.onload = function() {
            const savedData = localStorage.getItem('recitationData');
            const completed = document.getElementById('completed');
            const pending = document.getElementById('pending');
            
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    
                    // æ¸…ç©ºç°æœ‰æ•°æ®
                    completed.innerHTML = '';
                    pending.innerHTML = '';
                    
                    // æ¢å¤å·²èƒŒè¯µå­¦ç”Ÿ
                    data.completed.forEach(student => {
                        const studentDiv = createStudentElement(student);
                        completed.appendChild(studentDiv);
                    });
                    
                    // æ¢å¤æœªèƒŒè¯µå­¦ç”Ÿ
                    data.pending.forEach(student => {
                        const studentDiv = createStudentElement(student);
                        pending.appendChild(studentDiv);
                    });
                } catch (error) {
                    // å¦‚æœæ•°æ®è§£æå‡ºé”™ï¼Œæ¸…é™¤localStorage
                    localStorage.removeItem('recitationData');
                    console.error('æ•°æ®æ¢å¤å¤±è´¥:', error);
                }
            } else {
                // å¦‚æœæ²¡æœ‰ä¿å­˜çš„æ•°æ®ï¼Œç¡®ä¿ç¤ºä¾‹å­¦ç”Ÿåœ¨é‡å¤–åŒºåŸŸ
                completed.innerHTML = '';  // æ¸…ç©ºå®«æ®¿åŒºåŸŸ
            }
        };

        // ä¿®æ”¹å¯¼å…¥å­¦ç”Ÿåå•å‡½æ•°
        function importStudents(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            
            // æ ¹æ®æ–‡ä»¶ç±»å‹é€‰æ‹©ä¸åŒçš„å¤„ç†æ–¹å¼
            if (file.name.endsWith('.txt') || file.name.endsWith('.csv')) {
                reader.onload = function(e) {
                    const text = e.target.result;
                    const names = text.split(/[\n,]/) // æ”¯æŒæ¢è¡Œæˆ–é€—å·åˆ†éš”
                        .map(name => name.trim())
                        .filter(name => name.length > 0);
                    
                    addStudentsToList(names);
                };
                reader.readAsText(file);
            } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    // è·å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    
                    // å°†å·¥ä½œè¡¨è½¬æ¢ä¸ºæ•°ç»„
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                    
                    // æå–æ‰€æœ‰éç©ºçš„åå­—
                    const names = jsonData.flat()
                        .map(name => String(name).trim())
                        .filter(name => name.length > 0);
                    
                    addStudentsToList(names);
                };
                reader.readAsArrayBuffer(file);
            }
            
            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
            input.value = '';
        }

        // æ˜¾ç¤ºé€šçŸ¥æç¤º
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'game-notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // é¡µé¢åŠ è½½æ—¶ä¸ºæ‹–æ”¾åŒºåŸŸæ·»åŠ äº‹ä»¶ç›‘å¬
        let touchDragging = false;
        let draggedElement = null;
        let startX, startY;
        let initialX, initialY;
        let currentDropZone = null;

        function handleTouchStart(e) {
            const touch = e.touches[0];
            const card = touch.target.closest('.character-card');
            if (!card) return;

            e.preventDefault();
            touchDragging = true;
            draggedElement = card;
            
            // è®°å½•åˆå§‹è§¦æ‘¸ä½ç½®
            startX = touch.clientX;
            startY = touch.clientY;
            
            // è®°å½•å¡ç‰‡åˆå§‹ä½ç½®
            const rect = card.getBoundingClientRect();
            initialX = rect.left;
            initialY = rect.top;
            
            // æ·»åŠ æ‹–åŠ¨æ ·å¼
            card.style.position = 'fixed';
            card.style.zIndex = '1000';
            card.style.width = rect.width + 'px';
            card.style.left = initialX + 'px';
            card.style.top = initialY + 'px';
            card.classList.add('dragging');
        }

        function handleTouchMove(e) {
            if (!touchDragging || !draggedElement) return;
            e.preventDefault();

            const touch = e.touches[0];
            const deltaX = touch.clientX - startX;
            const deltaY = touch.clientY - startY;

            // ç§»åŠ¨å¡ç‰‡
            draggedElement.style.left = (initialX + deltaX) + 'px';
            draggedElement.style.top = (initialY + deltaY) + 'px';

            // æ£€æµ‹æ”¾ç½®åŒºåŸŸ
            const dropZones = document.querySelectorAll('.character-list, .disguise-box');
            let foundDropZone = null;

            dropZones.forEach(zone => {
                const rect = zone.getBoundingClientRect();
                if (touch.clientX >= rect.left && touch.clientX <= rect.right &&
                    touch.clientY >= rect.top && touch.clientY <= rect.bottom) {
                    foundDropZone = zone;
                }
            });

            // æ›´æ–°æ”¾ç½®åŒºåŸŸé«˜äº®
            if (currentDropZone && currentDropZone !== foundDropZone) {
                currentDropZone.classList.remove('drag-over');
            }
            if (foundDropZone) {
                foundDropZone.classList.add('drag-over');
                currentDropZone = foundDropZone;
            }
        }

        function handleTouchEnd(e) {
            if (!touchDragging || !draggedElement) return;
            e.preventDefault();

            // é‡ç½®å¡ç‰‡æ ·å¼
            draggedElement.style.position = '';
            draggedElement.style.zIndex = '';
            draggedElement.style.width = '';
            draggedElement.style.left = '';
            draggedElement.style.top = '';
            draggedElement.classList.remove('dragging');

            // å¤„ç†æ”¾ç½®
            if (currentDropZone) {
                currentDropZone.classList.remove('drag-over');
                
                // å¦‚æœæ˜¯æ˜“å®¹æœ¯æ–¹æ¡†ï¼Œåˆ™å¯åŠ¨å¤´åƒé€‰æ‹©åŠŸèƒ½
                if (currentDropZone.classList.contains('disguise-box')) {
                    window.currentStudentId = draggedElement.id;
                    showAvatarSelection();
                } else {
                    currentDropZone.appendChild(draggedElement);
                    draggedElement.classList.add('dropped');
                    setTimeout(() => {
                        draggedElement.classList.remove('dropped');
                    }, 300);
                }
            }

            // é‡ç½®çŠ¶æ€
            touchDragging = false;
            draggedElement = null;
            currentDropZone = null;
        }

        window.addEventListener('load', function() {
            const dropZones = document.querySelectorAll('.character-list, .disguise-box');
            dropZones.forEach(zone => {
                zone.addEventListener('dragover', allowDrop);
                zone.addEventListener('dragleave', dragLeave);
                zone.addEventListener('drop', zone.classList.contains('disguise-box') ? dropForDisguise : drop);
            });

            // æ·»åŠ è§¦æ‘¸äº‹ä»¶ç›‘å¬
            document.addEventListener('touchstart', handleTouchStart, { passive: false });
            document.addEventListener('touchmove', handleTouchMove, { passive: false });
            document.addEventListener('touchend', handleTouchEnd, { passive: false });
        });

        // æ·»åŠ é‡ç½®å‡½æ•°
        function resetStudents() {
            const completed = document.getElementById('completed');
            const pending = document.getElementById('pending');
            
            // è·å–æ‰€æœ‰å­¦ç”Ÿ
            const allStudents = Array.from(completed.children);
            
            // å°†æ‰€æœ‰å­¦ç”Ÿç§»åŠ¨åˆ°é‡å¤–åŒºåŸŸ
            allStudents.forEach(student => {
                // æ·»åŠ ç§»åŠ¨åŠ¨ç”»
                student.classList.add('resetting');
                
                // ç§»åŠ¨åˆ°é‡å¤–åŒºåŸŸ
                pending.appendChild(student);
                
                // ç§»é™¤åŠ¨ç”»ç±»
                setTimeout(() => {
                    student.classList.remove('resetting');
                }, 500);
            });
            
            // æ˜¾ç¤ºæç¤º
            if (allStudents.length > 0) {
                showNotification(`å·²å°† ${allStudents.length} åå­¦ç”Ÿé‡ç½®åˆ°é‡å¤–`);
            } else {
                showNotification('å®«æ®¿ä¸­æ²¡æœ‰éœ€è¦é‡ç½®çš„å­¦ç”Ÿ');
            }
        }

        // é‡ç½®æ•´ä¸ªå†’é™©çš„å‡½æ•°
        function resetAdventure() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ•´ä¸ªå†’é™©å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰å­¦ç”Ÿå’Œä»»åŠ¡æ•°æ®ï¼Œæ¢å¤åˆ°åˆå§‹çŠ¶æ€ã€‚æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                // æ¸…é™¤æ‰€æœ‰æœ¬åœ°å­˜å‚¨æ•°æ®
                localStorage.removeItem('recitationData');
                localStorage.removeItem('recitationTasks');
                localStorage.removeItem('currentTaskId');
                
                // é‡ç½®å½“å‰ä»»åŠ¡ID
                currentTaskId = null;
                
                // æ¸…ç©ºå·²å®ŒæˆåŒºåŸŸ
                document.getElementById('completed').innerHTML = '';
                
                // é‡ç½®æœªå®ŒæˆåŒºåŸŸä¸ºåˆå§‹çŠ¶æ€
                document.getElementById('pending').innerHTML = `
                    <div class="character-card" draggable="true" ondragstart="drag(event)" id="student1">
                        <div class="character-avatar">
                            <img src="images/avatar1.png" alt="è§’è‰²å¤´åƒ">
                        </div>
                        <span class="character-name">å¼ ä¸‰</span>
                    </div>
                    <div class="character-card" draggable="true" ondragstart="drag(event)" id="student2">
                        <div class="character-avatar">
                            <img src="images/avatar2.png" alt="è§’è‰²å¤´åƒ">
                        </div>
                        <span class="character-name">æå››</span>
                    </div>
                    <div class="character-card" draggable="true" ondragstart="drag(event)" id="student3">
                        <div class="character-avatar">
                            <img src="images/avatar3.png" alt="è§’è‰²å¤´åƒ">
                        </div>
                        <span class="character-name">ç‹äº”</span>
                    </div>
                    <div class="character-card" draggable="true" ondragstart="drag(event)" id="student4">
                        <div class="character-avatar">
                            <img src="images/avatar4.png" alt="è§’è‰²å¤´åƒ">
                        </div>
                        <span class="character-name">èµµå…­</span>
                    </div>
                `;
                
                // æ›´æ–°å½“å‰ä»»åŠ¡æ˜¾ç¤º
                updateCurrentTaskDisplay();
                
                // æ˜¾ç¤ºé€šçŸ¥
                showNotification('å†’é™©å·²é‡ç½®åˆ°åˆå§‹çŠ¶æ€');
            }
        }

        // ä¿®æ”¹ä»»åŠ¡ç®¡ç†ç›¸å…³å‡½æ•°
        let currentTaskId = null;  // æ·»åŠ å½“å‰ä»»åŠ¡IDçš„å…¨å±€å˜é‡

        function showTaskModal() {
            const modal = document.getElementById('taskModal');
            if (modal) {
                modal.style.display = 'block';
                loadTasks();
            }
        }

        function closeTaskModal() {
            const modal = document.getElementById('taskModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function addTask() {
            const taskInput = document.getElementById('newTaskName');
            const taskName = taskInput.value.trim();
            
            if (taskName) {
                // ä¿å­˜å½“å‰ä»»åŠ¡çŠ¶æ€ï¼Œä»¥é˜²æœ‰æœªä¿å­˜çš„æ›´æ”¹
                if (currentTaskId) {
                    saveCurrentTaskState();
                }
                
                const tasks = JSON.parse(localStorage.getItem('recitationTasks') || '[]');
                
                // åˆå¹¶å·²å®ŒæˆåŒºåŸŸå’Œæœªå®ŒæˆåŒºåŸŸçš„å­¦ç”Ÿï¼Œå…¨éƒ¨ç§»è‡³æœªå®ŒæˆåŒºåŸŸ
                const completedStudents = Array.from(document.getElementById('completed').children);
                const pendingStudents = Array.from(document.getElementById('pending').children);
                
                // ä»æ‰€æœ‰å­¦ç”Ÿåˆ›å»ºæ ‡å‡†æ ¼å¼çš„æ•°æ®
                const allStudents = [...completedStudents, ...pendingStudents].map(el => {
                    const avatarSrc = el.querySelector('img').src;
                    // æå–å¤´åƒæ–‡ä»¶å
                    const fileName = avatarSrc.split('/').pop();
                    return {
                        id: el.id,
                        name: el.querySelector('.character-name').textContent,
                        avatar: `images/${fileName}`
                    };
                });
                
                const newTask = {
                    id: Date.now(),
                    name: taskName,
                    date: new Date().toLocaleDateString(),
                    completed: [],
                    pending: allStudents // å°†æ‰€æœ‰å­¦ç”Ÿæ”¾åœ¨æœªå®ŒæˆåŒºåŸŸ
                };
                
                tasks.push(newTask);
                localStorage.setItem('recitationTasks', JSON.stringify(tasks));
                
                currentTaskId = newTask.id;
                localStorage.setItem('currentTaskId', newTask.id);
                
                // æ›´æ–°ç•Œé¢ï¼Œå°†æ‰€æœ‰å­¦ç”Ÿæ”¾åˆ°æœªå®ŒæˆåŒºåŸŸ
                const completed = document.getElementById('completed');
                const pending = document.getElementById('pending');
                
                completed.innerHTML = '';
                pending.innerHTML = '';
                
                allStudents.forEach(student => {
                    const studentDiv = createStudentElement(student);
                    pending.appendChild(studentDiv);
                });
                
                taskInput.value = '';
                loadTasks();
                updateCurrentTaskDisplay();
                showNotification(`å·²æ·»åŠ æ–°ä»»åŠ¡ï¼š${taskName}ï¼Œæ‰€æœ‰å†’é™©è€…å·²é‡ç½®åˆ°ä¿®ç‚¼é‡å¤–`);
                closeTaskModal();
            }
        }

        function loadTasks() {
            const taskList = document.getElementById('taskList');
            const tasks = JSON.parse(localStorage.getItem('recitationTasks') || '[]');
            
            taskList.innerHTML = tasks.map(task => `
                <div class="task-item ${currentTaskId === task.id ? 'active' : ''}">
                    <div class="task-info">
                        <span class="task-name">${task.name}</span>
                        <span class="task-date">${task.date}</span>
                        <div class="task-stats">
                            å·²å®Œæˆ: ${task.completed.length} / æ€»äººæ•°: ${task.completed.length + task.pending.length}
                        </div>
                    </div>
                    <div class="task-actions">
                        <button onclick="switchToTask(${task.id})" class="game-btn switch-btn">
                            ${currentTaskId === task.id ? 'å½“å‰ä»»åŠ¡' : 'åˆ‡æ¢è‡³æ­¤ä»»åŠ¡'}
                        </button>
                        <button onclick="deleteTask(${task.id})" class="game-btn delete-btn">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        // ä¿®æ”¹åˆ‡æ¢ä»»åŠ¡å‡½æ•°ï¼Œç¡®ä¿å…¨å±€ä¸€è‡´çš„å¤´åƒå¤„ç†
        function switchToTask(taskId) {
            const tasks = JSON.parse(localStorage.getItem('recitationTasks') || '[]');
            const task = tasks.find(t => t.id === taskId);
            
            if (task) {
                // ä¿å­˜å½“å‰ä»»åŠ¡çš„çŠ¶æ€
                if (currentTaskId) {
                    saveCurrentTaskState();
                }
                
                // åˆ‡æ¢åˆ°æ–°ä»»åŠ¡
                currentTaskId = taskId;
                localStorage.setItem('currentTaskId', taskId);
                
                // æ›´æ–°ç•Œé¢
                const completed = document.getElementById('completed');
                const pending = document.getElementById('pending');
                
                completed.innerHTML = '';
                pending.innerHTML = '';
                
                // ç¡®ä¿å­¦ç”ŸIDæ˜¯å”¯ä¸€çš„ï¼Œé¿å…é‡å¤
                const studentIds = new Set();
                
                // æ¢å¤å·²å®Œæˆå­¦ç”Ÿ
                task.completed.forEach(student => {
                    if (!student.id || studentIds.has(student.id)) {
                        student.id = 'student' + Date.now() + Math.random().toString(36).substr(2, 9);
                    }
                    studentIds.add(student.id);
                    const studentDiv = createStudentElement(student);
                    completed.appendChild(studentDiv);
                });
                
                // æ¢å¤æœªå®Œæˆå­¦ç”Ÿ
                task.pending.forEach(student => {
                    if (!student.id || studentIds.has(student.id)) {
                        student.id = 'student' + Date.now() + Math.random().toString(36).substr(2, 9);
                    }
                    studentIds.add(student.id);
                    const studentDiv = createStudentElement(student);
                    pending.appendChild(studentDiv);
                });
                
                // æ›´æ–°å¥–ç‰Œæ˜¾ç¤º
                updateAllMedals();
                
                updateCurrentTaskDisplay();
                closeTaskModal();
                showNotification(`å·²åˆ‡æ¢åˆ°ä»»åŠ¡ï¼š${task.name}`);
                loadTasks();
            }
        }

        // ä¿®æ”¹ä¿å­˜ä»»åŠ¡çŠ¶æ€çš„å‡½æ•°ï¼Œç¡®ä¿ä¿å­˜å¤´åƒä¿¡æ¯
        function saveCurrentTaskState() {
            if (!currentTaskId) return;
            
            const tasks = JSON.parse(localStorage.getItem('recitationTasks') || '[]');
            const taskIndex = tasks.findIndex(t => t.id === currentTaskId);
            
            if (taskIndex !== -1) {
                // ä¿å­˜å½“å‰çŠ¶æ€
                const completed = Array.from(document.getElementById('completed').children)
                    .map(el => {
                        const avatarSrc = el.querySelector('img').src;
                        // æå–å¤´åƒæ–‡ä»¶å
                        const fileName = avatarSrc.split('/').pop();
                        return {
                            id: el.id,
                            name: el.querySelector('.character-name').textContent,
                            avatar: `images/${fileName}`
                        };
                    });
                    
                const pending = Array.from(document.getElementById('pending').children)
                    .map(el => {
                        const avatarSrc = el.querySelector('img').src;
                        // æå–å¤´åƒæ–‡ä»¶å
                        const fileName = avatarSrc.split('/').pop();
                        return {
                            id: el.id,
                            name: el.querySelector('.character-name').textContent,
                            avatar: `images/${fileName}`
                        };
                    });
                
                tasks[taskIndex].completed = completed;
                tasks[taskIndex].pending = pending;
                
                localStorage.setItem('recitationTasks', JSON.stringify(tasks));
            }
        }

        // åœ¨é¡µé¢å…³é—­æˆ–åˆ·æ–°å‰è‡ªåŠ¨ä¿å­˜
        window.addEventListener('beforeunload', function() {
            saveCurrentTaskState();
        });

        function deleteTask(taskId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤ä»»åŠ¡å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚')) {
                const tasks = JSON.parse(localStorage.getItem('recitationTasks') || '[]');
                const updatedTasks = tasks.filter(task => task.id !== taskId);
                localStorage.setItem('recitationTasks', JSON.stringify(updatedTasks));
                
                if (currentTaskId === taskId) {
                    currentTaskId = null;
                    localStorage.removeItem('currentTaskId');
                    document.getElementById('completed').innerHTML = '';
                    document.getElementById('pending').innerHTML = '';
                }
                
                loadTasks();
                showNotification('ä»»åŠ¡å·²åˆ é™¤');
            }
        }

        // æ·»åŠ æ›´æ–°å½“å‰ä»»åŠ¡æ˜¾ç¤ºçš„å‡½æ•°
        function updateCurrentTaskDisplay() {
            const display = document.getElementById('currentTaskDisplay');
            if (currentTaskId) {
                const tasks = JSON.parse(localStorage.getItem('recitationTasks') || '[]');
                const currentTask = tasks.find(t => t.id === currentTaskId);
                if (currentTask) {
                    display.innerHTML = `
                        <span class="task-label">å½“å‰ä»»åŠ¡:</span>
                        <span class="task-name">${currentTask.name}</span>
                    `;
                }
            } else {
                display.innerHTML = `
                    <span class="task-label">å½“å‰ä»»åŠ¡:</span>
                    <span class="task-name">æœªé€‰æ‹©ä»»åŠ¡</span>
                `;
            }
        }

        // ç¡®ä¿åœ¨é¡µé¢åŠ è½½å®Œæˆåå†æ·»åŠ äº‹ä»¶ç›‘å¬
        document.addEventListener('DOMContentLoaded', function() {
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            const modal = document.getElementById('taskModal');
            if (modal) {
                modal.addEventListener('click', function(event) {
                    if (event.target === modal) {
                        closeTaskModal();
                    }
                });
            }

            // æ¢å¤å½“å‰ä»»åŠ¡
            const savedTaskId = localStorage.getItem('currentTaskId');
            if (savedTaskId) {
                switchToTask(parseInt(savedTaskId));
            } else {
                const tasks = JSON.parse(localStorage.getItem('recitationTasks') || '[]');
                if (tasks.length > 0) {
                    switchToTask(tasks[tasks.length - 1].id);
                }
            }
            updateCurrentTaskDisplay();
        });
    </script>
</body>
</html>