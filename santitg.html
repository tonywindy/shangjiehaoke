<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ä¸‰é¢˜é€šå…³ - ç²¾å‡†è®¡ç®—è®­ç»ƒè¥</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }

        .container {
            width: 100%;
            max-width: 800px;
            background: white;
            border-radius: 30px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        /* ä¸»é¡µæ ·å¼ */
        .page {
            display: none;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .title {
            text-align: center;
            color: #667eea;
            font-size: 36px;
            margin-bottom: 30px;
            font-weight: bold;
        }

        /* æˆé•¿ä¹‹æ ‘æ ·å¼ */
        .tree-container {
            text-align: center;
            margin: 30px 0;
            padding: 30px;
            background: linear-gradient(to bottom, #e0f7fa 0%, #f1f8e9 100%);
            border-radius: 20px;
            position: relative;
            overflow: hidden;
        }

        .tree-display {
            font-size: 120px;
            height: 180px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.5s ease;
        }

        .tree-info {
            font-size: 24px;
            color: #4caf50;
            font-weight: bold;
            margin-top: 15px;
        }

        .tree-level {
            font-size: 18px;
            color: #666;
            margin-top: 10px;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 18px 50px;
            font-size: 24px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 15px rgba(102, 126, 234, 0.4);
            display: block;
            margin: 20px auto;
            width: fit-content;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 20px rgba(102, 126, 234, 0.6);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        /* é€‰æ‹©é¡µé¢æ ·å¼ */
        .selection-group {
            margin: 40px 0;
        }

        .selection-title {
            font-size: 28px;
            color: #333;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .radio-option {
            background: #f5f5f5;
            padding: 20px 25px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
            display: flex;
            align-items: center;
        }

        .radio-option:hover {
            background: #e8eaf6;
            transform: translateX(5px);
        }

        .radio-option:active {
            transform: scale(0.98);
        }

        .radio-option.selected {
            background: #e8eaf6;
            border-color: #667eea;
        }

        .radio-option input[type="radio"] {
            display: none;
        }

        .radio-label {
            font-size: 22px;
            color: #333;
            cursor: pointer;
            width: 100%;
            display: flex;
            align-items: center;
        }

        .radio-label::before {
            content: '';
            width: 24px;
            height: 24px;
            border: 3px solid #667eea;
            border-radius: 50%;
            margin-right: 15px;
            display: inline-block;
            transition: all 0.3s ease;
        }

        .radio-option.selected .radio-label::before {
            background: #667eea;
            box-shadow: inset 0 0 0 4px white;
        }

        .mode-description {
            font-size: 16px;
            color: #666;
            margin-left: 39px;
            margin-top: 5px;
        }

        /* ç­”é¢˜ç•Œé¢æ ·å¼ */
        .questions-container {
            margin: 30px 0;
        }

        .question-item {
            background: #f9f9f9;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .question-item.error {
            background: #ffebee;
            border: 2px solid #f44336;
        }

        .question-text {
            font-size: 32px;
            color: #333;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .answer-input {
            width: 100%;
            padding: 15px 20px;
            font-size: 28px;
            border: 3px solid #ddd;
            border-radius: 10px;
            transition: all 0.3s ease;
            text-align: center;
        }

        .answer-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }

        .answer-input.error {
            border-color: #f44336;
        }

        .error-mark {
            color: #f44336;
            font-size: 24px;
            margin-top: 10px;
            font-weight: bold;
            display: none;
        }

        .error-mark.show {
            display: block;
        }

        /* æç¤ºä¿¡æ¯ */
        .message-box {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            font-size: 20px;
            text-align: center;
            display: none;
        }

        .message-box.show {
            display: block;
            animation: shake 0.5s ease;
        }

        .message-box.error {
            background: #ffebee;
            border-color: #f44336;
            color: #c62828;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        /* å®Œæˆç•Œé¢æ ·å¼ */
        .completion-container {
            text-align: center;
            padding: 40px 0;
        }

        .celebration {
            font-size: 100px;
            margin: 20px 0;
            animation: bounce 1s ease infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .completion-message {
            font-size: 32px;
            color: #4caf50;
            margin: 20px 0;
            font-weight: bold;
        }

        .points-animation {
            font-size: 48px;
            color: #ff9800;
            font-weight: bold;
            margin: 30px 0;
            animation: pointsFloat 1s ease;
        }

        @keyframes pointsFloat {
            0% { opacity: 0; transform: translateY(50px) scale(0.5); }
            50% { opacity: 1; transform: translateY(-10px) scale(1.2); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }

        .btn-group {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 30px;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        /* å‡çº§åŠ¨ç”» */
        .level-up-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .level-up-overlay.show {
            display: flex;
            animation: fadeIn 0.5s ease;
        }

        .level-up-content {
            background: white;
            padding: 50px;
            border-radius: 30px;
            text-align: center;
            animation: scaleIn 0.5s ease;
        }

        @keyframes scaleIn {
            0% { transform: scale(0.5); }
            100% { transform: scale(1); }
        }

        .level-up-text {
            font-size: 48px;
            color: #ff9800;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .level-up-tree {
            font-size: 150px;
            margin: 20px 0;
        }

        /* å“åº”å¼è®¾è®¡ - æ‰‹æœºç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            body {
                padding: 10px;
                align-items: flex-start;
                padding-top: 20px;
            }

            .container {
                padding: 20px 15px;
                border-radius: 20px;
                margin: 0 auto;
            }

            .title {
                font-size: 26px;
                margin-bottom: 20px;
            }

            /* æˆé•¿ä¹‹æ ‘ä¼˜åŒ– */
            .tree-container {
                padding: 20px 15px;
                margin: 20px 0;
            }

            .tree-display {
                font-size: 80px;
                height: 100px;
            }

            .tree-info {
                font-size: 20px;
            }

            .tree-level {
                font-size: 16px;
            }

            /* é€‰æ‹©é¡µé¢ä¼˜åŒ– */
            .selection-group {
                margin: 25px 0;
            }

            .selection-title {
                font-size: 22px;
                margin-bottom: 15px;
            }

            .radio-option {
                padding: 18px 15px;
            }

            .radio-label {
                font-size: 18px;
            }

            .radio-label::before {
                width: 20px;
                height: 20px;
                border-width: 2px;
                margin-right: 12px;
                flex-shrink: 0;
            }

            .mode-description {
                font-size: 14px;
                margin-left: 32px;
            }

            /* ç­”é¢˜ç•Œé¢ä¼˜åŒ– */
            .questions-container {
                margin: 20px 0;
            }

            .question-item {
                padding: 18px 15px;
                margin-bottom: 15px;
            }

            .question-text {
                font-size: 22px;
                margin-bottom: 12px;
                line-height: 1.4;
            }

            .answer-input {
                font-size: 24px;
                padding: 12px 15px;
                border-width: 2px;
                /* ç§»åŠ¨ç«¯æ•°å­—é”®ç›˜ä¼˜åŒ– */
                -webkit-appearance: none;
                appearance: none;
            }

            .error-mark {
                font-size: 18px;
                margin-top: 8px;
            }

            /* æŒ‰é’®ä¼˜åŒ– - æ›´å¤§æ›´å¥½ç‚¹å‡» */
            .btn {
                font-size: 20px;
                padding: 16px 35px;
                width: 100%;
                max-width: 300px;
                margin: 15px auto;
                /* è§¦æ‘¸ä¼˜åŒ– */
                -webkit-tap-highlight-color: rgba(255, 255, 255, 0.3);
                touch-action: manipulation;
            }

            .btn:active {
                transform: scale(0.95);
            }

            .btn-group {
                flex-direction: column;
                gap: 12px;
                margin-top: 20px;
            }

            /* æ¶ˆæ¯æ¡†ä¼˜åŒ– */
            .message-box {
                padding: 15px;
                font-size: 18px;
                margin: 15px 0;
                line-height: 1.5;
            }

            /* å®Œæˆé¡µé¢ä¼˜åŒ– */
            .completion-container {
                padding: 20px 0;
            }

            .celebration {
                font-size: 80px;
                margin: 15px 0;
            }

            .completion-message {
                font-size: 24px;
                margin: 15px 0;
            }

            .points-animation {
                font-size: 40px;
                margin: 20px 0;
            }

            /* å‡çº§åŠ¨ç”»ä¼˜åŒ– */
            .level-up-content {
                padding: 30px 20px;
                border-radius: 20px;
                margin: 0 15px;
                max-width: 90%;
            }

            .level-up-text {
                font-size: 32px;
                margin-bottom: 15px;
            }

            .level-up-tree {
                font-size: 100px;
                margin: 15px 0;
            }
        }

        /* è¶…å°å±å¹•ä¼˜åŒ– (å°äº375px) */
        @media (max-width: 375px) {
            body {
                padding: 8px;
                padding-top: 15px;
            }

            .container {
                padding: 18px 12px;
            }

            .title {
                font-size: 24px;
                margin-bottom: 18px;
            }

            .tree-display {
                font-size: 70px;
                height: 90px;
            }

            .tree-info {
                font-size: 18px;
            }

            .tree-level {
                font-size: 14px;
            }

            .selection-title {
                font-size: 20px;
            }

            .radio-label {
                font-size: 17px;
            }

            .question-text {
                font-size: 20px;
            }

            .answer-input {
                font-size: 22px;
                padding: 12px;
            }

            .btn {
                font-size: 18px;
                padding: 14px 30px;
            }

            .completion-message {
                font-size: 22px;
            }

            .points-animation {
                font-size: 36px;
            }

            .level-up-text {
                font-size: 28px;
            }

            .level-up-tree {
                font-size: 90px;
            }
        }

        /* æ¨ªå±æ¨¡å¼ä¼˜åŒ– */
        @media (max-height: 600px) and (orientation: landscape) {
            body {
                align-items: flex-start;
                padding: 10px;
            }

            .tree-display {
                font-size: 60px;
                height: 80px;
            }

            .celebration {
                font-size: 60px;
            }

            .level-up-content {
                padding: 20px;
            }

            .level-up-tree {
                font-size: 80px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ä¸»é¡µ -->
        <div id="homePage" class="page active">
            <h1 class="title">ğŸ¯ ä¸‰é¢˜é€šå…³</h1>
            <div class="tree-container">
                <div class="tree-display" id="treeDisplay">ğŸŒ±</div>
                <div class="tree-info">æ€»ç§¯åˆ†: <span id="totalPoints">0</span> åˆ†</div>
                <div class="tree-level" id="treeLevel">ç§å­é˜¶æ®µ</div>
            </div>
            <button class="btn" onclick="goToSelection()">å¼€å§‹è®­ç»ƒ</button>
        </div>

        <!-- é€‰æ‹©é¡µé¢ -->
        <div id="selectionPage" class="page">
            <h1 class="title">é€‰æ‹©è®­ç»ƒ</h1>
            
            <div class="selection-group">
                <div class="selection-title">ğŸ“š é€‰æ‹©è®­ç»ƒå†…å®¹</div>
                <div class="radio-group">
                    <div class="radio-option selected" onclick="selectContent('addition')">
                        <label class="radio-label">
                            <input type="radio" name="content" value="addition" checked>
                            ä¸‰ä½æ•°åŠ å‡æ··åˆè¿ç®—
                        </label>
                    </div>
                    <div class="radio-option" onclick="selectContent('multiplication')">
                        <label class="radio-label">
                            <input type="radio" name="content" value="multiplication">
                            è¡¨å†…ä¹˜æ³•å››åˆ™æ··åˆè¿ç®—
                        </label>
                    </div>
                </div>
            </div>

            <div class="selection-group">
                <div class="selection-title">ğŸ® é€‰æ‹©è®­ç»ƒæ¨¡å¼</div>
                <div class="radio-group">
                    <div class="radio-option selected" onclick="selectMode('easy')">
                        <label class="radio-label">
                            <input type="radio" name="mode" value="easy" checked>
                            ç®€å•æ¨¡å¼
                        </label>
                        <div class="mode-description">ä¸¤æ­¥è¿ç®—ï¼Œæç¤ºé”™é¢˜ä½ç½®ï¼Œç§¯åˆ† +1</div>
                    </div>
                    <div class="radio-option" onclick="selectMode('hard')">
                        <label class="radio-label">
                            <input type="radio" name="mode" value="hard">
                            å›°éš¾æ¨¡å¼
                        </label>
                        <div class="mode-description">ä¸¤æ­¥è¿ç®—ï¼Œåªæç¤ºé”™é¢˜æ•°é‡ï¼Œç§¯åˆ† +2</div>
                    </div>
                    <div class="radio-option" onclick="selectMode('master')">
                        <label class="radio-label">
                            <input type="radio" name="mode" value="master">
                            å¤§å¸ˆæ¨¡å¼
                        </label>
                        <div class="mode-description">å››æ­¥è¿ç®—ï¼Œåªæç¤ºé”™é¢˜æ•°é‡ï¼Œç§¯åˆ† +3</div>
                    </div>
                </div>
            </div>

            <button class="btn" onclick="startTraining()">ç¡®è®¤ï¼Œå¼€å§‹è®­ç»ƒ</button>
        </div>

        <!-- ç­”é¢˜é¡µé¢ -->
        <div id="trainingPage" class="page">
            <h1 class="title">ğŸ“ å¼€å§‹ç­”é¢˜</h1>
            
            <div class="message-box" id="messageBox"></div>
            
            <div class="questions-container" id="questionsContainer">
                <!-- é¢˜ç›®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>

            <div class="btn-group">
                <button class="btn" onclick="submitAnswers()">æäº¤æ£€æŸ¥</button>
                <button class="btn btn-secondary" onclick="backToSelection()">è¿”å›ä¸Šä¸€æ­¥</button>
            </div>
        </div>

        <!-- å®Œæˆé¡µé¢ -->
        <div id="completionPage" class="page">
            <div class="completion-container">
                <div class="celebration">ğŸ‰</div>
                <div class="completion-message">æ­å–œä½ ï¼Œå…¨éƒ¨æ­£ç¡®ï¼</div>
                <div class="completion-message">æœ¬ç»„è®­ç»ƒå®Œæˆï¼</div>
                <div class="points-animation" id="pointsAnimation">+1 åˆ†</div>
                <div class="tree-info">å½“å‰æ€»ç§¯åˆ†: <span id="currentPoints">0</span> åˆ†</div>
                
                <div class="btn-group">
                    <button class="btn" onclick="nextRound()">å¼€å§‹ä¸‹ä¸€ç»„</button>
                    <button class="btn btn-secondary" onclick="goHome()">è¿”å›ä¸»é¡µ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å‡çº§åŠ¨ç”»è¦†ç›–å±‚ -->
    <div class="level-up-overlay" id="levelUpOverlay">
        <div class="level-up-content">
            <div class="level-up-text">ğŸŠ æ­å–œå‡çº§ï¼ğŸŠ</div>
            <div class="level-up-tree" id="levelUpTree">ğŸŒ±</div>
            <div class="tree-level" id="levelUpText">ç ´åœŸè€Œå‡ºçš„å°æ ‘è‹—</div>
            <button class="btn" onclick="closeLevelUp()">å¤ªæ£’äº†ï¼</button>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentContent = 'addition'; // å½“å‰è®­ç»ƒå†…å®¹
        let currentMode = 'easy'; // å½“å‰è®­ç»ƒæ¨¡å¼
        let currentQuestions = []; // å½“å‰é¢˜ç›®é›†
        let totalPoints = 0; // æ€»ç§¯åˆ†

        // æ ‘çš„ç­‰çº§é…ç½®
        const treeLevels = [
            { minPoints: 0, maxPoints: 1, emoji: 'ğŸŒ±', name: 'ç§å­é˜¶æ®µ' },
            { minPoints: 2, maxPoints: 5, emoji: 'ğŸŒ¿', name: 'ç ´åœŸè€Œå‡ºçš„å°æ ‘è‹—' },
            { minPoints: 6, maxPoints: 15, emoji: 'ğŸŒ³', name: 'èŒå£®çš„å°æ ‘è‹—' },
            { minPoints: 16, maxPoints: 30, emoji: 'ğŸŒ²', name: 'æœ‰èŒ‚å¯†æ ‘å¶çš„å°æ ‘' },
            { minPoints: 31, maxPoints: 50, emoji: 'ğŸ„', name: 'å¥å£®çš„å¤§æ ‘' },
            { minPoints: 51, maxPoints: 100, emoji: 'ğŸŒ¸', name: 'å¼€èŠ±çš„å¤§æ ‘' },
            { minPoints: 101, maxPoints: Infinity, emoji: 'ğŸ', name: 'ç»“æ»¡æœå®çš„å¤§æ ‘' }
        ];

        // åˆå§‹åŒ–
        function init() {
            loadProgress();
            updateTreeDisplay();
        }

        // åŠ è½½è¿›åº¦
        function loadProgress() {
            const saved = localStorage.getItem('santitg_progress');
            if (saved) {
                const data = JSON.parse(saved);
                totalPoints = data.totalPoints || 0;
            }
        }

        // ä¿å­˜è¿›åº¦
        function saveProgress() {
            localStorage.setItem('santitg_progress', JSON.stringify({
                totalPoints: totalPoints
            }));
        }

        // æ›´æ–°æ ‘çš„æ˜¾ç¤º
        function updateTreeDisplay() {
            const level = getTreeLevel(totalPoints);
            document.getElementById('treeDisplay').textContent = level.emoji;
            document.getElementById('totalPoints').textContent = totalPoints;
            document.getElementById('treeLevel').textContent = level.name;
        }

        // è·å–æ ‘çš„ç­‰çº§
        function getTreeLevel(points) {
            for (let level of treeLevels) {
                if (points >= level.minPoints && points <= level.maxPoints) {
                    return level;
                }
            }
            return treeLevels[treeLevels.length - 1];
        }

        // é¡µé¢åˆ‡æ¢
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
        }

        // å‰å¾€é€‰æ‹©é¡µé¢
        function goToSelection() {
            showPage('selectionPage');
        }

        // é€‰æ‹©å†…å®¹
        function selectContent(content) {
            currentContent = content;
            document.querySelectorAll('#selectionPage .radio-option').forEach((option, index) => {
                if (index < 2) {
                    option.classList.remove('selected');
                }
            });
            event.currentTarget.classList.add('selected');
        }

        // é€‰æ‹©æ¨¡å¼
        function selectMode(mode) {
            currentMode = mode;
            document.querySelectorAll('#selectionPage .radio-option').forEach((option, index) => {
                if (index >= 2) { // å¤„ç†æ¨¡å¼é€‰é¡¹ï¼ˆç¬¬3,4,5ä¸ªé€‰é¡¹ï¼‰
                    option.classList.remove('selected');
                }
            });
            event.currentTarget.classList.add('selected');
        }

        // å¼€å§‹è®­ç»ƒ
        function startTraining() {
            generateQuestions();
            renderQuestions();
            showPage('trainingPage');
        }

        // ç”Ÿæˆé¢˜ç›®
        function generateQuestions() {
            currentQuestions = [];
            const isMasterMode = currentMode === 'master';
            
            if (currentContent === 'addition') {
                // ä¸‰ä½æ•°åŠ å‡æ··åˆè¿ç®—
                for (let i = 0; i < 3; i++) {
                    currentQuestions.push(generateAdditionQuestion(isMasterMode));
                }
            } else {
                // è¡¨å†…ä¹˜æ³•å››åˆ™æ··åˆè¿ç®—
                for (let i = 0; i < 3; i++) {
                    currentQuestions.push(generateMultiplicationQuestion(isMasterMode));
                }
            }
        }

        // ç”Ÿæˆä¸‰ä½æ•°åŠ å‡æ··åˆè¿ç®—ï¼ˆåŒ…å«å°æ‹¬å·ï¼‰
        function generateAdditionQuestion(isMasterMode = false) {
            // å¤§å¸ˆæ¨¡å¼ç”Ÿæˆå››æ­¥è¿ç®—
            if (isMasterMode) {
                return generateFourStepAdditionQuestion();
            }
            
            const num1 = Math.floor(Math.random() * 900) + 100; // 100-999
            const num2 = Math.floor(Math.random() * 900) + 100;
            const num3 = Math.floor(Math.random() * 900) + 100;
            
            // 50%æ¦‚ç‡ç”Ÿæˆå¸¦å°æ‹¬å·çš„é¢˜ç›®
            const useParentheses = Math.random() < 0.5;
            
            if (useParentheses) {
                // å¸¦å°æ‹¬å·çš„é¢˜ç›®
                const templates = [
                    // åä¸¤ä¸ªæ•°æœ‰æ‹¬å·
                    { q: (a, b, c) => `${a} + (${b} + ${c})`, a: (a, b, c) => a + (b + c) },
                    { q: (a, b, c) => `${a} + (${b} - ${c})`, a: (a, b, c) => a + (b - c) },
                    { q: (a, b, c) => `${a} - (${b} + ${c})`, a: (a, b, c) => a - (b + c) },
                    { q: (a, b, c) => `${a} - (${b} - ${c})`, a: (a, b, c) => a - (b - c) },
                    // å‰ä¸¤ä¸ªæ•°æœ‰æ‹¬å·
                    { q: (a, b, c) => `(${a} + ${b}) + ${c}`, a: (a, b, c) => (a + b) + c },
                    { q: (a, b, c) => `(${a} + ${b}) - ${c}`, a: (a, b, c) => (a + b) - c },
                    { q: (a, b, c) => `(${a} - ${b}) + ${c}`, a: (a, b, c) => (a - b) + c },
                    { q: (a, b, c) => `(${a} - ${b}) - ${c}`, a: (a, b, c) => (a - b) - c }
                ];
                
                const template = templates[Math.floor(Math.random() * templates.length)];
                const question = template.q(num1, num2, num3);
                const answer = template.a(num1, num2, num3);
                
                return { question, answer };
            } else {
                // ä¸å¸¦å°æ‹¬å·çš„é¢˜ç›®
                const operators = [
                    ['+', '+'],
                    ['+', '-'],
                    ['-', '+'],
                    ['-', '-']
                ];
                const ops = operators[Math.floor(Math.random() * operators.length)];
                
                const question = `${num1} ${ops[0]} ${num2} ${ops[1]} ${num3}`;
                let answer = num1;
                if (ops[0] === '+') answer += num2;
                else answer -= num2;
                if (ops[1] === '+') answer += num3;
                else answer -= num3;
                
                return { question, answer };
            }
        }

        // ç”Ÿæˆå››æ­¥åŠ å‡æ··åˆè¿ç®—ï¼ˆå¤§å¸ˆæ¨¡å¼ï¼‰
        function generateFourStepAdditionQuestion() {
            const num1 = Math.floor(Math.random() * 900) + 100; // 100-999
            const num2 = Math.floor(Math.random() * 900) + 100;
            const num3 = Math.floor(Math.random() * 900) + 100;
            const num4 = Math.floor(Math.random() * 900) + 100;
            const num5 = Math.floor(Math.random() * 900) + 100;
            
            // å››æ­¥è¿ç®—æ¨¡æ¿ï¼ˆå¸¦å°æ‹¬å·ï¼‰
            const templates = [
                // ä¸€ä¸ªæ‹¬å·åŒ…å«ä¸¤ä¸ªæ•°
                { q: (a, b, c, d, e) => `(${a} + ${b}) + ${c} - ${d} + ${e}`, a: (a, b, c, d, e) => (a + b) + c - d + e },
                { q: (a, b, c, d, e) => `(${a} - ${b}) + ${c} + ${d} - ${e}`, a: (a, b, c, d, e) => (a - b) + c + d - e },
                { q: (a, b, c, d, e) => `${a} + (${b} + ${c}) - ${d} + ${e}`, a: (a, b, c, d, e) => a + (b + c) - d + e },
                { q: (a, b, c, d, e) => `${a} - (${b} - ${c}) + ${d} - ${e}`, a: (a, b, c, d, e) => a - (b - c) + d - e },
                { q: (a, b, c, d, e) => `${a} + ${b} - (${c} + ${d}) + ${e}`, a: (a, b, c, d, e) => a + b - (c + d) + e },
                { q: (a, b, c, d, e) => `${a} - ${b} + (${c} - ${d}) + ${e}`, a: (a, b, c, d, e) => a - b + (c - d) + e },
                // ä¸¤ä¸ªæ‹¬å·
                { q: (a, b, c, d, e) => `(${a} + ${b}) + (${c} - ${d}) + ${e}`, a: (a, b, c, d, e) => (a + b) + (c - d) + e },
                { q: (a, b, c, d, e) => `(${a} - ${b}) - (${c} - ${d}) + ${e}`, a: (a, b, c, d, e) => (a - b) - (c - d) + e },
                { q: (a, b, c, d, e) => `${a} + (${b} + ${c}) - (${d} + ${e})`, a: (a, b, c, d, e) => a + (b + c) - (d + e) },
                { q: (a, b, c, d, e) => `${a} - (${b} - ${c}) + (${d} - ${e})`, a: (a, b, c, d, e) => a - (b - c) + (d - e) },
            ];
            
            const template = templates[Math.floor(Math.random() * templates.length)];
            const question = template.q(num1, num2, num3, num4, num5);
            const answer = template.a(num1, num2, num3, num4, num5);
            
            return { question, answer };
        }

        // ç”Ÿæˆè¡¨å†…ä¹˜æ³•å››åˆ™æ··åˆè¿ç®—ï¼ˆä¸¤æ­¥ï¼šä¹˜åŠ ã€ä¹˜å‡ã€é™¤åŠ ã€é™¤å‡ï¼ŒåŒ…å«å°æ‹¬å·ï¼‰
        function generateMultiplicationQuestion(isMasterMode = false) {
            // å¤§å¸ˆæ¨¡å¼ç”Ÿæˆå››æ­¥è¿ç®—
            if (isMasterMode) {
                return generateFourStepMultiplicationQuestion();
            }
            
            // 50%æ¦‚ç‡ç”Ÿæˆå¸¦å°æ‹¬å·çš„é¢˜ç›®
            const useParentheses = Math.random() < 0.5;
            
            if (useParentheses) {
                // å¸¦å°æ‹¬å·çš„é¢˜ç›®ï¼ˆç¡®ä¿ä¹˜æ³•åªæ¶‰åŠè¡¨å†…ä¹˜æ³•1-9Ã—1-9ï¼ŒåŠ å‡æ³•å¯ç”¨ä¸¤ä½æ•°ï¼‰
                const templates = [
                    // ä¹˜æ³•ååŠ æ³•ï¼ˆå¸¦æ‹¬å·ï¼‰ï¼ša Ã— b + (c + d)
                    { 
                        q: () => {
                            const a = Math.floor(Math.random() * 9) + 1; // è¡¨å†…ä¹˜æ³•
                            const b = Math.floor(Math.random() * 9) + 1; // è¡¨å†…ä¹˜æ³•
                            const c = Math.floor(Math.random() * 90) + 10; // ä¸¤ä½æ•°
                            const d = Math.floor(Math.random() * 90) + 10; // ä¸¤ä½æ•°
                            return { question: `${a} Ã— ${b} + (${c} + ${d})`, answer: a * b + (c + d) };
                        }
                    },
                    // ä¹˜æ³•ååŠ æ³•ï¼ˆå¸¦æ‹¬å·ï¼‰ï¼ša Ã— b + (c - d)
                    { 
                        q: () => {
                            const a = Math.floor(Math.random() * 9) + 1;
                            const b = Math.floor(Math.random() * 9) + 1;
                            const c = Math.floor(Math.random() * 90) + 10; // ä¸¤ä½æ•°
                            const d = Math.floor(Math.random() * (c - 10)) + 10; // ä¸¤ä½æ•°ï¼Œä¸”d<c
                            return { question: `${a} Ã— ${b} + (${c} - ${d})`, answer: a * b + (c - d) };
                        }
                    },
                    // ä¹˜æ³•åå‡æ³•ï¼ˆå¸¦æ‹¬å·ï¼‰ï¼ša Ã— b - (c + d)
                    { 
                        q: () => {
                            const a = Math.floor(Math.random() * 7) + 3; // 3-9
                            const b = Math.floor(Math.random() * 7) + 3; // 3-9
                            const product = a * b; // è‡³å°‘9
                            const c = Math.floor(Math.random() * 15) + 10; // 10-24
                            const maxD = Math.min(product - c - 1, 30);
                            const d = Math.floor(Math.random() * Math.max(1, maxD)) + 10; // ä¸¤ä½æ•°
                            if (product > c + d) {
                                return { question: `${a} Ã— ${b} - (${c} + ${d})`, answer: product - (c + d) };
                            } else {
                                // å¦‚æœä¸æ»¡è¶³ï¼Œè¿”å›ç®€å•çš„ä¹˜åŠ 
                                const e = Math.floor(Math.random() * 90) + 10;
                                return { question: `${a} Ã— ${b} + ${e}`, answer: product + e };
                            }
                        }
                    },
                    // ä¹˜æ³•åå‡æ³•ï¼ˆå¸¦æ‹¬å·ï¼‰ï¼ša Ã— b - (c - d)
                    { 
                        q: () => {
                            const a = Math.floor(Math.random() * 9) + 1;
                            const b = Math.floor(Math.random() * 9) + 1;
                            const product = a * b;
                            const c = Math.floor(Math.random() * 50) + 30; // 30-79
                            const minD = Math.max(10, c - product + 1);
                            if (minD < c) {
                                const d = Math.floor(Math.random() * (c - minD)) + minD; // ä¸¤ä½æ•°
                                return { question: `${a} Ã— ${b} - (${c} - ${d})`, answer: product - (c - d) };
                            } else {
                                // å¦‚æœä¸æ»¡è¶³ï¼Œè¿”å›ç®€å•çš„ä¹˜åŠ 
                                const e = Math.floor(Math.random() * 90) + 10;
                                return { question: `${a} Ã— ${b} + ${e}`, answer: product + e };
                            }
                        }
                    },
                    // é™¤æ³•ååŠ æ³•ï¼ˆå¸¦æ‹¬å·ï¼‰ï¼ša Ã· b + (c + d)
                    { 
                        q: () => {
                            const b = Math.floor(Math.random() * 8) + 2; // é™¤æ•°2-9
                            const quotient = Math.floor(Math.random() * 9) + 1; // å•†1-9
                            const a = b * quotient; // è¢«é™¤æ•°
                            const c = Math.floor(Math.random() * 90) + 10; // ä¸¤ä½æ•°
                            const d = Math.floor(Math.random() * 90) + 10; // ä¸¤ä½æ•°
                            return { question: `${a} Ã· ${b} + (${c} + ${d})`, answer: quotient + (c + d) };
                        }
                    },
                    // é™¤æ³•ååŠ æ³•ï¼ˆå¸¦æ‹¬å·ï¼‰ï¼ša Ã· b + (c - d)
                    { 
                        q: () => {
                            const b = Math.floor(Math.random() * 8) + 2;
                            const quotient = Math.floor(Math.random() * 9) + 1;
                            const a = b * quotient;
                            const c = Math.floor(Math.random() * 90) + 10; // ä¸¤ä½æ•°
                            const d = Math.floor(Math.random() * (c - 10)) + 10; // ä¸¤ä½æ•°ï¼Œä¸”d<c
                            return { question: `${a} Ã· ${b} + (${c} - ${d})`, answer: quotient + (c - d) };
                        }
                    },
                    // é™¤æ³•åå‡æ³•ï¼ˆå¸¦æ‹¬å·ï¼‰ï¼ša Ã· b - (c - d)
                    { 
                        q: () => {
                            const b = Math.floor(Math.random() * 8) + 2;
                            const quotient = Math.floor(Math.random() * 50) + 30; // å•†30-79
                            const a = b * quotient;
                            const c = Math.floor(Math.random() * 60) + 30; // 30-89
                            const minD = Math.max(10, c - quotient + 1);
                            if (minD < c - 5) {
                                const d = Math.floor(Math.random() * (c - minD)) + minD;
                                return { question: `${a} Ã· ${b} - (${c} - ${d})`, answer: quotient - (c - d) };
                            } else {
                                // å¦‚æœä¸æ»¡è¶³ï¼Œè¿”å›ç®€å•çš„é™¤åŠ 
                                const e = Math.floor(Math.random() * 90) + 10;
                                return { question: `${a} Ã· ${b} + ${e}`, answer: quotient + e };
                            }
                        }
                    }
                ];
                
                const template = templates[Math.floor(Math.random() * templates.length)];
                return template.q();
            } else {
                // ä¸å¸¦å°æ‹¬å·çš„é¢˜ç›®ï¼ˆä¹˜åŠ ã€ä¹˜å‡ã€é™¤åŠ ã€é™¤å‡ï¼‰
                const questionTypes = ['mul_add', 'mul_sub', 'div_add', 'div_sub'];
                const type = questionTypes[Math.floor(Math.random() * questionTypes.length)];
                
                let question, answer;
                
                if (type === 'mul_add') {
                    // ä¹˜åŠ ï¼ša Ã— b + cï¼ˆcæ˜¯ä¸¤ä½æ•°ï¼‰
                    const a = Math.floor(Math.random() * 9) + 1;
                    const b = Math.floor(Math.random() * 9) + 1;
                    const c = Math.floor(Math.random() * 90) + 10; // 10-99çš„ä¸¤ä½æ•°
                    question = `${a} Ã— ${b} + ${c}`;
                    answer = a * b + c;
                } else if (type === 'mul_sub') {
                    // ä¹˜å‡ï¼ša Ã— b - cï¼ˆcæ˜¯ä¸¤ä½æ•°ï¼‰
                    const a = Math.floor(Math.random() * 9) + 1;
                    const b = Math.floor(Math.random() * 9) + 1;
                    const product = a * b;
                    const c = Math.floor(Math.random() * Math.min(90, product)) + 10; // 10-99çš„ä¸¤ä½æ•°ï¼Œä¸”ä¸è¶…è¿‡ä¹˜ç§¯
                    question = `${a} Ã— ${b} - ${c}`;
                    answer = product - c;
                } else if (type === 'div_add') {
                    // é™¤åŠ ï¼ša Ã· b + cï¼ˆcæ˜¯ä¸¤ä½æ•°ï¼‰
                    const b = Math.floor(Math.random() * 8) + 2; // é™¤æ•°2-9
                    const quotient = Math.floor(Math.random() * 9) + 1; // å•†
                    const a = quotient * b; // è¢«é™¤æ•°ï¼Œä¿è¯èƒ½æ•´é™¤
                    const c = Math.floor(Math.random() * 90) + 10; // 10-99çš„ä¸¤ä½æ•°
                    question = `${a} Ã· ${b} + ${c}`;
                    answer = quotient + c;
                } else { // div_sub
                    // é™¤å‡ï¼ša Ã· b - cï¼ˆcæ˜¯ä¸¤ä½æ•°ï¼Œä½†è¦ä¿è¯ç»“æœä¸ºæ­£ï¼‰
                    const b = Math.floor(Math.random() * 8) + 2; // é™¤æ•°2-9
                    const quotient = Math.floor(Math.random() * 80) + 20; // å•†20-99ï¼Œä¿è¯èƒ½å‡å»ä¸¤ä½æ•°
                    const a = quotient * b; // è¢«é™¤æ•°ï¼Œä¿è¯èƒ½æ•´é™¤
                    const c = Math.floor(Math.random() * (quotient - 10)) + 10; // 10åˆ°quotient-1ä¹‹é—´çš„ä¸¤ä½æ•°
                    question = `${a} Ã· ${b} - ${c}`;
                    answer = quotient - c;
                }
                
                return { question, answer };
            }
        }

        // ç”Ÿæˆå››æ­¥ä¹˜é™¤æ··åˆè¿ç®—ï¼ˆå¤§å¸ˆæ¨¡å¼ï¼‰
        function generateFourStepMultiplicationQuestion() {
            // å››æ­¥è¿ç®—æ¨¡æ¿ï¼ˆå¸¦å°æ‹¬å·ï¼Œç¡®ä¿ä¹˜æ³•åªæ¶‰åŠè¡¨å†…ä¹˜æ³•ï¼ŒåŠ å‡æ³•ä½¿ç”¨ä¸¤ä½æ•°ï¼‰
            const templates = [
                // ä¹˜åŠ åŠ ï¼ša Ã— b + c + d
                { 
                    q: () => {
                        const a = Math.floor(Math.random() * 9) + 1;
                        const b = Math.floor(Math.random() * 9) + 1;
                        const c = Math.floor(Math.random() * 90) + 10; // ä¸¤ä½æ•°
                        const d = Math.floor(Math.random() * 90) + 10; // ä¸¤ä½æ•°
                        return { question: `${a} Ã— ${b} + ${c} + ${d}`, answer: a * b + c + d };
                    }
                },
                // ä¹˜åŠ å‡ï¼ša Ã— b + c - d
                { 
                    q: () => {
                        const a = Math.floor(Math.random() * 9) + 1;
                        const b = Math.floor(Math.random() * 9) + 1;
                        const c = Math.floor(Math.random() * 90) + 10;
                        const d = Math.floor(Math.random() * 90) + 10;
                        return { question: `${a} Ã— ${b} + ${c} - ${d}`, answer: a * b + c - d };
                    }
                },
                // ä¹˜å‡åŠ ï¼ša Ã— b - c + d
                { 
                    q: () => {
                        const a = Math.floor(Math.random() * 9) + 1;
                        const b = Math.floor(Math.random() * 9) + 1;
                        const c = Math.floor(Math.random() * 90) + 10;
                        const d = Math.floor(Math.random() * 90) + 10;
                        return { question: `${a} Ã— ${b} - ${c} + ${d}`, answer: a * b - c + d };
                    }
                },
                // å¸¦æ‹¬å·çš„ä¹˜æ³•åŠ æ³•ï¼ša Ã— b + (c + d)
                { 
                    q: () => {
                        const a = Math.floor(Math.random() * 9) + 1; // è¡¨å†…ä¹˜æ³•
                        const b = Math.floor(Math.random() * 9) + 1; // è¡¨å†…ä¹˜æ³•
                        const c = Math.floor(Math.random() * 90) + 10; // ä¸¤ä½æ•°
                        const d = Math.floor(Math.random() * 90) + 10; // ä¸¤ä½æ•°
                        return { question: `${a} Ã— ${b} + (${c} + ${d})`, answer: a * b + (c + d) };
                    }
                },
                // å¸¦æ‹¬å·çš„ä¹˜æ³•å‡æ³•ï¼ša Ã— b + (c - d)
                { 
                    q: () => {
                        const a = Math.floor(Math.random() * 9) + 1;
                        const b = Math.floor(Math.random() * 9) + 1;
                        const c = Math.floor(Math.random() * 90) + 10;
                        const d = Math.floor(Math.random() * (c - 10)) + 10;
                        return { question: `${a} Ã— ${b} + (${c} - ${d})`, answer: a * b + (c - d) };
                    }
                },
                // é™¤æ³•æ··åˆï¼ša Ã· b + c + d
                { 
                    q: () => {
                        const b = Math.floor(Math.random() * 8) + 2;
                        const quotient = Math.floor(Math.random() * 9) + 1;
                        const a = quotient * b;
                        const c = Math.floor(Math.random() * 90) + 10;
                        const d = Math.floor(Math.random() * 90) + 10;
                        return { question: `${a} Ã· ${b} + ${c} + ${d}`, answer: quotient + c + d };
                    }
                },
                // é™¤æ³•æ··åˆï¼ša Ã· b + c - d
                { 
                    q: () => {
                        const b = Math.floor(Math.random() * 8) + 2;
                        const quotient = Math.floor(Math.random() * 9) + 1;
                        const a = quotient * b;
                        const c = Math.floor(Math.random() * 90) + 10;
                        const d = Math.floor(Math.random() * 90) + 10;
                        return { question: `${a} Ã· ${b} + ${c} - ${d}`, answer: quotient + c - d };
                    }
                },
                // ä¹˜é™¤æ··åˆï¼ša Ã— b Ã· c + dï¼ˆä¿è¯aÃ—bèƒ½è¢«cæ•´é™¤ï¼Œä¸”éƒ½æ˜¯è¡¨å†…ä¹˜æ³•ï¼‰
                { 
                    q: () => {
                        const c = Math.floor(Math.random() * 8) + 2; // é™¤æ•°2-9
                        const quotient = Math.floor(Math.random() * 9) + 1; // å•†1-9
                        const product = c * quotient; // ç¡®ä¿èƒ½æ•´é™¤
                        // å°†productåˆ†è§£ä¸ºä¸¤ä¸ªè¡¨å†…ä¹˜æ³•å› å­
                        let a, b;
                        if (product <= 9) {
                            a = 1;
                            b = product;
                        } else {
                            // æ‰¾åˆ°productçš„å› å­å¯¹
                            const factors = [];
                            for (let i = 1; i <= 9; i++) {
                                if (product % i === 0 && product / i <= 9) {
                                    factors.push([i, product / i]);
                                }
                            }
                            if (factors.length > 0) {
                                const [f1, f2] = factors[Math.floor(Math.random() * factors.length)];
                                a = f1;
                                b = f2;
                            } else {
                                // å¦‚æœæ— æ³•åˆ†è§£ï¼Œæ”¹ä¸ºç®€å•çš„ä¹˜åŠ 
                                a = Math.floor(Math.random() * 9) + 1;
                                b = Math.floor(Math.random() * 9) + 1;
                                const d = Math.floor(Math.random() * 90) + 10;
                                return { question: `${a} Ã— ${b} + ${d}`, answer: a * b + d };
                            }
                        }
                        const d = Math.floor(Math.random() * 90) + 10;
                        return { question: `${a} Ã— ${b} Ã· ${c} + ${d}`, answer: a * b / c + d };
                    }
                },
                // å¸¦æ‹¬å·çš„åŠ æ³•åä¹˜æ³•ï¼ša Ã— b - (c - d)
                { 
                    q: () => {
                        const a = Math.floor(Math.random() * 9) + 1;
                        const b = Math.floor(Math.random() * 9) + 1;
                        const product = a * b;
                        const c = Math.floor(Math.random() * 60) + 30;
                        const minD = Math.max(10, c - product + 1);
                        if (minD < c - 5) {
                            const d = Math.floor(Math.random() * (c - minD)) + minD;
                            return { question: `${a} Ã— ${b} - (${c} - ${d})`, answer: product - (c - d) };
                        } else {
                            const d = Math.floor(Math.random() * 90) + 10;
                            return { question: `${a} Ã— ${b} + ${d}`, answer: product + d };
                        }
                    }
                },
                // æ··åˆæ‹¬å·ï¼ša Ã— b + (c + d)
                { 
                    q: () => {
                        const a = Math.floor(Math.random() * 9) + 1;
                        const b = Math.floor(Math.random() * 9) + 1;
                        const c = Math.floor(Math.random() * 90) + 10;
                        const d = Math.floor(Math.random() * 90) + 10;
                        return { question: `${a} Ã— ${b} + (${c} + ${d})`, answer: a * b + (c + d) };
                    }
                },
                // æ··åˆæ‹¬å·ï¼ša Ã— b - (c - d)
                { 
                    q: () => {
                        const a = Math.floor(Math.random() * 9) + 1;
                        const b = Math.floor(Math.random() * 9) + 1;
                        const c = Math.floor(Math.random() * 90) + 10;
                        const d = Math.floor(Math.random() * (c - 10)) + 10;
                        return { question: `${a} Ã— ${b} - (${c} - ${d})`, answer: a * b - (c - d) };
                    }
                }
            ];
            
            const template = templates[Math.floor(Math.random() * templates.length)];
            return template.q();
        }

        // æ¸²æŸ“é¢˜ç›®
        function renderQuestions() {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';
            
            currentQuestions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-item';
                questionDiv.innerHTML = `
                    <div class="question-text">ç¬¬ ${index + 1} é¢˜: ${q.question} = ?</div>
                    <input type="number" inputmode="numeric" pattern="[0-9]*" class="answer-input" id="answer${index}" 
                           placeholder="è¯·è¾“å…¥ç­”æ¡ˆ">
                    <div class="error-mark" id="error${index}">âŒ è¿™é“é¢˜ç­”é”™äº†</div>
                `;
                container.appendChild(questionDiv);
            });
            
            // æ¸…ç©ºæç¤ºä¿¡æ¯
            document.getElementById('messageBox').classList.remove('show');
        }

        // æäº¤ç­”æ¡ˆ
        function submitAnswers() {
            const userAnswers = [];
            const errorIndexes = [];
            
            // æ”¶é›†ç”¨æˆ·ç­”æ¡ˆå¹¶æ£€æŸ¥
            currentQuestions.forEach((q, index) => {
                const input = document.getElementById(`answer${index}`);
                const userAnswer = parseInt(input.value);
                userAnswers.push(userAnswer);
                
                if (userAnswer !== q.answer) {
                    errorIndexes.push(index);
                }
            });
            
            // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯æ ‡è®°
            document.querySelectorAll('.question-item').forEach(item => {
                item.classList.remove('error');
            });
            document.querySelectorAll('.error-mark').forEach(mark => {
                mark.classList.remove('show');
            });
            document.querySelectorAll('.answer-input').forEach(input => {
                input.classList.remove('error');
            });
            
            const messageBox = document.getElementById('messageBox');
            
            if (errorIndexes.length === 0) {
                // å…¨éƒ¨æ­£ç¡®
                completeTraining();
            } else {
                // æœ‰é”™è¯¯
                if (currentMode === 'easy') {
                    // ç®€å•æ¨¡å¼ï¼šæ ‡è®°é”™é¢˜
                    errorIndexes.forEach(index => {
                        document.querySelector(`#answer${index}`).closest('.question-item').classList.add('error');
                        document.getElementById(`error${index}`).classList.add('show');
                        document.getElementById(`answer${index}`).classList.add('error');
                    });
                    
                    messageBox.textContent = 'ä½ æœ‰é¢˜ç›®ç­”é”™äº†ï¼Œè¯·ä¿®æ”¹åå†æäº¤ã€‚';
                    messageBox.className = 'message-box error show';
                } else if (currentMode === 'hard') {
                    // å›°éš¾æ¨¡å¼ï¼šåªæç¤ºé”™è¯¯æ•°é‡
                    messageBox.textContent = `ä½ æäº¤çš„ç­”æ¡ˆä¸­ï¼Œæœ‰ ${errorIndexes.length} é“æ˜¯é”™è¯¯çš„ï¼Œè¯·è‡ªå·±æ£€æŸ¥ä¸€éï¼Œä¿®æ”¹åå†æäº¤ã€‚`;
                    messageBox.className = 'message-box show';
                } else {
                    // å¤§å¸ˆæ¨¡å¼ï¼šåªæç¤ºé”™è¯¯æ•°é‡
                    messageBox.textContent = `ä½ æäº¤çš„ç­”æ¡ˆä¸­ï¼Œæœ‰ ${errorIndexes.length} é“æ˜¯é”™è¯¯çš„ï¼Œè¯·è‡ªå·±æ£€æŸ¥ä¸€éï¼Œä¿®æ”¹åå†æäº¤ã€‚`;
                    messageBox.className = 'message-box show';
                }
            }
        }

        // å®Œæˆè®­ç»ƒ
        function completeTraining() {
            const oldLevel = getTreeLevel(totalPoints);
            
            // å¢åŠ ç§¯åˆ†
            let pointsEarned;
            if (currentMode === 'easy') {
                pointsEarned = 1;
            } else if (currentMode === 'hard') {
                pointsEarned = 2;
            } else {
                pointsEarned = 3; // å¤§å¸ˆæ¨¡å¼
            }
            totalPoints += pointsEarned;
            
            // ä¿å­˜è¿›åº¦
            saveProgress();
            
            // æ›´æ–°å®Œæˆé¡µé¢
            document.getElementById('pointsAnimation').textContent = `+${pointsEarned} åˆ†`;
            document.getElementById('currentPoints').textContent = totalPoints;
            
            // æ˜¾ç¤ºå®Œæˆé¡µé¢
            showPage('completionPage');
            
            // æ£€æŸ¥æ˜¯å¦å‡çº§
            const newLevel = getTreeLevel(totalPoints);
            if (newLevel.minPoints !== oldLevel.minPoints) {
                setTimeout(() => {
                    showLevelUp(newLevel);
                }, 1000);
            }
        }

        // æ˜¾ç¤ºå‡çº§åŠ¨ç”»
        function showLevelUp(level) {
            document.getElementById('levelUpTree').textContent = level.emoji;
            document.getElementById('levelUpText').textContent = level.name;
            document.getElementById('levelUpOverlay').classList.add('show');
        }

        // å…³é—­å‡çº§åŠ¨ç”»
        function closeLevelUp() {
            document.getElementById('levelUpOverlay').classList.remove('show');
            updateTreeDisplay();
        }

        // ä¸‹ä¸€ç»„
        function nextRound() {
            updateTreeDisplay();
            showPage('selectionPage');
        }

        // è¿”å›ä¸»é¡µ
        function goHome() {
            updateTreeDisplay();
            showPage('homePage');
        }

        // è¿”å›é€‰æ‹©é¡µé¢
        function backToSelection() {
            // æ¸…ç©ºç­”é¢˜ç•Œé¢çš„æ•°æ®å’ŒçŠ¶æ€
            document.getElementById('messageBox').classList.remove('show');
            document.querySelectorAll('.question-item').forEach(item => {
                item.classList.remove('error');
            });
            document.querySelectorAll('.error-mark').forEach(mark => {
                mark.classList.remove('show');
            });
            document.querySelectorAll('.answer-input').forEach(input => {
                input.classList.remove('error');
            });
            
            // è¿”å›é€‰æ‹©é¡µé¢
            showPage('selectionPage');
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', init);
    </script>
</body>
</html>

